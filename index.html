
<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üéÆ Co-op Finder ‚Äî –†–µ–∞–ª—å–Ω—ã–π –ø–æ–∏—Å–∫ –Ω–∞–ø–∞—Ä–Ω–∏–∫–æ–≤</title>
    <style>
        :root {
            --bg: #0f0f1a;
            --card-bg: #1a1a2e;
            --accent: #7b68ee;
            --accent-light: #4fc3f7;
            --text: #e0e0ff;
            --text-secondary: #aaaaff;
            --border: rgba(100, 100, 255, 0.2);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: var(--bg);
            color: var(--text);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        header {
            text-align: center;
            padding: 30px 0;
        }

        h1 {
            font-size: 2.5em;
            margin: 0 0 15px;
            background: linear-gradient(90deg, var(--accent), var(--accent-light));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .main {
            display: flex;
            gap: 30px;
            flex-wrap: wrap;
        }

        .sidebar {
            flex: 1;
            min-width: 300px;
            background: var(--card-bg);
            border-radius: 20px;
            padding: 25px;
            box-shadow: 0 0 20px rgba(100, 100, 255, 0.2);
        }

        .content {
            flex: 2;
            min-width: 300px;
        }

        .card {
            background: var(--card-bg);
            border-radius: 20px;
            padding: 25px;
            margin-bottom: 30px;
            box-shadow: 0 0 20px rgba(100, 100, 255, 0.2);
            border: 1px solid var(--border);
        }

        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
        }

        input, select, textarea {
            width: 100%;
            padding: 12px 15px;
            border-radius: 10px;
            border: 1px solid var(--border);
            background: rgba(30, 30, 50, 0.8);
            color: var(--text);
            font-size: 16px;
        }

        button {
            background: linear-gradient(90deg, var(--accent), var(--accent-light));
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 50px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 16px;
            margin-right: 10px;
            margin-bottom: 10px;
        }

        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(123, 104, 238, 0.4);
        }

        .player-list {
            max-height: 400px;
            overflow-y: auto;
            margin-top: 20px;
        }

        .player-card {
            background: rgba(40, 40, 70, 0.6);
            padding: 15px;
            border-radius: 15px;
            margin-bottom: 15px;
            border: 1px solid var(--border);
            cursor: pointer;
            transition: all 0.3s;
        }

        .player-card:hover {
            transform: translateX(5px);
            border-color: var(--accent);
            box-shadow: 0 5px 15px rgba(123, 104, 238, 0.3);
        }

        .player-card h3 {
            margin: 0 0 10px;
            color: var(--accent);
        }

        .player-info {
            font-size: 14px;
            color: var(--text-secondary);
            margin-bottom: 10px;
        }

        .chat-container {
            height: 400px;
            background: var(--card-bg);
            border-radius: 15px;
            padding: 20px;
            overflow-y: auto;
            margin-bottom: 20px;
            border: 1px solid var(--border);
            display: flex;
            flex-direction: column;
        }

        .message {
            margin-bottom: 15px;
            padding: 10px 15px;
            border-radius: 15px;
            max-width: 80%;
            word-wrap: break-word;
            align-self: flex-start;
        }

        .message.sent {
            background: var(--accent);
            color: white;
            margin-left: auto;
            align-self: flex-end;
        }

        .message.received {
            background: rgba(40, 40, 70, 0.6);
        }

        .chat-input {
            display: flex;
            gap: 10px;
        }

        .chat-input input {
            flex: 1;
        }

        .tabs {
            display: flex;
            margin-bottom: 20px;
            border-bottom: 1px solid var(--border);
        }

        .tab {
            padding: 10px 20px;
            cursor: pointer;
            border-bottom: 3px solid transparent;
        }

        .tab.active {
            border-bottom: 3px solid var(--accent);
            color: var(--accent);
            font-weight: bold;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .profile-section {
            display: none;
        }

        .profile-section.active {
            display: block;
        }

        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: var(--text-secondary);
        }

        .status {
            text-align: center;
            padding: 10px;
            margin: 10px 0;
            border-radius: 10px;
            font-size: 14px;
        }

        .status.online {
            background: rgba(46, 204, 113, 0.2);
            color: #2ecc71;
        }

        .status.error {
            background: rgba(255, 71, 87, 0.2);
            color: #ff4757;
        }

        .loader {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255,255,255,.3);
            border-radius: 50%;
            border-top-color: var(--accent);
            animation: spin 1s ease-in-out infinite;
            margin: 10px auto;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        #firebase-error {
            background: #ff4757;
            color: white;
            padding: 10px;
            border-radius: 10px;
            margin: 10px 0;
            display: none;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>üéÆ Co-op Finder</h1>
            <p>–ù–∞—Å—Ç–æ—è—â–∏–µ –ª—é–¥–∏. –ù–∞—Å—Ç–æ—è—â–∏–µ –∫–æ–æ–ø–µ—Ä–∞—Ç–∏–≤—ã.</p>
            <div id="firebase-error"></div>
            <div id="auth-status" class="status">–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è...</div>
        </header>

        <div class="main">
            <div class="sidebar">
                <div class="tabs">
                    <div class="tab active" data-tab="search">–ü–æ–∏—Å–∫ –∏–≥—Ä–æ–∫–æ–≤</div>
                    <div class="tab" data-tab="profile">–ú–æ–π –ø—Ä–æ—Ñ–∏–ª—å</div>
                    <div class="tab" data-tab="chat">–ß–∞—Ç—ã</div>
                </div>

                <div id="search-tab" class="tab-content active">
                    <div class="card">
                        <h2>–ü–æ–∏—Å–∫ –Ω–∞–ø–∞—Ä–Ω–∏–∫–æ–≤</h2>
                        <div class="form-group">
                            <label for="search-game">–ò–≥—Ä–∞</label>
                            <select id="search-game">
                                <option value="">–õ—é–±–∞—è –∏–≥—Ä–∞</option>
                                <option value="baldurs-gate-3">Baldur's Gate 3</option>
                                <option value="it-takes-two">It Takes Two</option>
                                <option value="deep-rock-galactic">Deep Rock Galactic</option>
                                <option value="overcooked">Overcooked 2</option>
                                <option value="monster-hunter">Monster Hunter</option>
                                <option value="elden-ring">Elden Ring</option>
                                <option value="other">–î—Ä—É–≥–∞—è...</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="search-platform">–ü–ª–∞—Ç—Ñ–æ—Ä–º–∞</label>
                            <select id="search-platform">
                                <option value="">–õ—é–±–∞—è –ø–ª–∞—Ç—Ñ–æ—Ä–º–∞</option>
                                <option value="pc">PC (Steam/Epic)</option>
                                <option value="ps5">PlayStation 5</option>
                                <option value="xbox">Xbox Series X/S</option>
                                <option value="switch">Nintendo Switch</option>
                            </select>
                        </div>
                        <button id="search-button">–ù–∞–π—Ç–∏ –∏–≥—Ä–æ–∫–æ–≤</button>
                    </div>

                    <div class="card">
                        <h2>–ê–∫—Ç–∏–≤–Ω—ã–µ –∏–≥—Ä–æ–∫–∏</h2>
                        <div id="players-list" class="player-list">
                            <div class="empty-state">
                                <div class="loader"></div>
                                <p>–ó–∞–≥—Ä—É–∑–∫–∞ —Å–ø–∏—Å–∫–∞ –∏–≥—Ä–æ–∫–æ–≤...</p>
                            </div>
                        </div>
                    </div>
                </div>

                <div id="profile-tab" class="tab-content">
                    <div class="card">
                        <h2>–í–∞—à –ø—Ä–æ—Ñ–∏–ª—å</h2>
                        <div class="form-group">
                            <label for="username">–ò–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</label>
                            <input type="text" id="username" placeholder="–í–∞—à –∏–≥—Ä–æ–≤–æ–π –Ω–∏–∫">
                        </div>
                        <div class="form-group">
                            <label for="main-game">–û—Å–Ω–æ–≤–Ω–∞—è –∏–≥—Ä–∞</label>
                            <select id="main-game">
                                <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –∏–≥—Ä—É</option>
                                <option value="baldurs-gate-3">Baldur's Gate 3</option>
                                <option value="it-takes-two">It Takes Two</option>
                                <option value="deep-rock-galactic">Deep Rock Galactic</option>
                                <option value="overcooked">Overcooked 2</option>
                                <option value="monster-hunter">Monster Hunter</option>
                                <option value="elden-ring">Elden Ring</option>
                                <option value="other">–î—Ä—É–≥–∞—è...</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="platform">–ü–ª–∞—Ç—Ñ–æ—Ä–º–∞</label>
                            <select id="platform">
                                <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –ø–ª–∞—Ç—Ñ–æ—Ä–º—É</option>
                                <option value="pc">PC (Steam/Epic)</option>
                                <option value="ps5">PlayStation 5</option>
                                <option value="xbox">Xbox Series X/S</option>
                                <option value="switch">Nintendo Switch</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="play-time">–ö–æ–≥–¥–∞ –∏–≥—Ä–∞–µ—Ç–µ?</label>
                            <select id="play-time">
                                <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –≤—Ä–µ–º—è</option>
                                <option value="evenings">–í–µ—á–µ—Ä–∞ (–ø–æ—Å–ª–µ 19:00)</option>
                                <option value="weekends">–í—ã—Ö–æ–¥–Ω—ã–µ</option>
                                <option value="flexible">–ì–∏–±–∫–∏–π –≥—Ä–∞—Ñ–∏–∫</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="play-style">–°—Ç–∏–ª—å –∏–≥—Ä—ã</label>
                            <select id="play-style">
                                <option value="">–í—ã–±–µ—Ä–∏—Ç–µ —Å—Ç–∏–ª—å</option>
                                <option value="casual">–ö–∞–∑—É–∞–ª (–¥–ª—è —Ñ–∞–Ω–∞)</option>
                                <option value="hardcore">–•–∞—Ä–¥–∫–æ—Ä (100% –ø—Ä–æ—Ö–æ–∂–¥–µ–Ω–∏–µ)</option>
                                <option value="explorer">–ò—Å—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å (—Å–æ–±–∏—Ä–∞—é –≤—Å—ë)</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="mic">–ú–∏–∫—Ä–æ—Ñ–æ–Ω</label>
                            <select id="mic">
                                <option value="yes">–ï—Å—Ç—å, –≥–æ—Ç–æ–≤ –æ–±—â–∞—Ç—å—Å—è</option>
                                <option value="no">–ù–µ—Ç/–Ω–µ –∏—Å–ø–æ–ª—å–∑—É—é</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="bio">–û —Å–µ–±–µ (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)</label>
                            <textarea id="bio" rows="3" placeholder="–†–∞—Å—Å–∫–∞–∂–∏—Ç–µ –æ —Å–µ–±–µ, —Å–≤–æ–µ–º —Å—Ç–∏–ª–µ –∏–≥—Ä—ã..."></textarea>
                        </div>
                        <button id="save-profile">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –ø—Ä–æ—Ñ–∏–ª—å</button>
                    </div>
                </div>

                <div id="chat-tab" class="tab-content">
                    <div class="card">
                        <h2>–í–∞—à–∏ —á–∞—Ç—ã</h2>
                        <div id="chats-list">
                            <div class="empty-state">
                                <div class="loader"></div>
                                <p>–ó–∞–≥—Ä—É–∑–∫–∞ —á–∞—Ç–æ–≤...</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="content">
                <div id="chat-section" class="profile-section">
                    <div class="card">
                        <h2 id="chat-title">–í—ã–±–µ—Ä–∏—Ç–µ –∏–≥—Ä–æ–∫–∞ –¥–ª—è –Ω–∞—á–∞–ª–∞ —á–∞—Ç–∞</h2>
                        <div id="chat-container" class="chat-container">
                            <div class="empty-state">
                                <p>–í—ã–±–µ—Ä–∏—Ç–µ –∏–≥—Ä–æ–∫–∞ –∏–∑ —Å–ø–∏—Å–∫–∞, —á—Ç–æ–±—ã –Ω–∞—á–∞—Ç—å —á–∞—Ç</p>
                            </div>
                        </div>
                        <div class="chat-input">
                            <input type="text" id="message-input" placeholder="–í–≤–µ–¥–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ..." disabled>
                            <button id="send-message" disabled>–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script type="module">
        // Import the functions you need from the SDKs you need
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getAnalytics } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-analytics.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        import { getFirestore, collection, doc, setDoc, getDoc, query, where, onSnapshot, addDoc, orderBy, serverTimestamp, getDocs, limit } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

        // Your web app's Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyAgcGshM7QlRy_lE-jeVvv8X5p9bDORy0w",
            authDomain: "gefd-88f41.firebaseapp.com",
            projectId: "gefd-88f41",
            storageBucket: "gefd-88f41.firebasestorage.app",
            messagingSenderId: "188695764382",
            appId: "1:188695764382:web:df05c7f5cf7aa246e0ca8f",
            measurementId: "G-J1R6XETDES"
        };

        // Initialize Firebase
        let app, auth, db;
        let currentUser = null;
        let currentChatPartner = null;
        let unsubscribePlayers = null;
        let unsubscribeChats = null;

        function showError(message) {
            const errorDiv = document.getElementById('firebase-error');
            errorDiv.textContent = message;
            errorDiv.style.display = 'block';
            document.getElementById('auth-status').textContent = '–û—à–∏–±–∫–∞: ' + message;
            document.getElementById('auth-status').className = 'status error';
        }

        function hideError() {
            document.getElementById('firebase-error').style.display = 'none';
        }

        async function initializeFirebase() {
            try {
                document.getElementById('auth-status').textContent = '–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Firebase...';
                
                // Initialize Firebase app
                app = initializeApp(firebaseConfig);
                
                // Get services
                auth = getAuth(app);
                db = getFirestore(app);
                
                // Initialize analytics if available
                try {
                    const analytics = getAnalytics(app);
                } catch (e) {
                    console.log('Analytics not available in this environment');
                }
                
                document.getElementById('auth-status').textContent = 'Firebase –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω! –ù–∞—á–∏–Ω–∞–µ–º –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—é...';
                return true;
            } catch (error) {
                showError('–û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ Firebase: ' + error.message);
                console.error('Firebase initialization error:', error);
                return false;
            }
        }

        // Initialize the app
        async function initApp() {
            // First, initialize Firebase
            const firebaseInitialized = await initializeFirebase();
            if (!firebaseInitialized) {
                return;
            }
            
            try {
                document.getElementById('auth-status').textContent = '–ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è –∞–Ω–æ–Ω–∏–º–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è...';
                
                // Wait for auth state to be ready
                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        // User is signed in
                        currentUser = user;
                        document.getElementById('auth-status').textContent = '–í—ã –≤–æ—à–ª–∏ –∫–∞–∫ –ò–≥—Ä–æ–∫ ' + currentUser.uid.slice(0, 6);
                        document.getElementById('auth-status').className = 'status online';
                        
                        // Load user profile if exists
                        await loadUserProfile();
                        
                        // Setup UI
                        initEventListeners();
                        switchTab('search');
                        
                        // Start listening for players
                        listenForPlayers();
                    } else {
                        // No user is signed in, sign in anonymously
                        try {
                            const userCredential = await signInAnonymously(auth);
                            currentUser = userCredential.user;
                            document.getElementById('auth-status').textContent = '–í—ã –≤–æ—à–ª–∏ –∫–∞–∫ –ò–≥—Ä–æ–∫ ' + currentUser.uid.slice(0, 6);
                            document.getElementById('auth-status').className = 'status online';
                            
                            // Load user profile if exists
                            await loadUserProfile();
                            
                            // Setup UI
                            initEventListeners();
                            switchTab('search');
                            
                            // Start listening for players
                            listenForPlayers();
                        } catch (error) {
                            showError('–û—à–∏–±–∫–∞ –∞–Ω–æ–Ω–∏–º–Ω–æ–π –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏: ' + error.message);
                            console.error('Anonymous sign-in error:', error);
                        }
                    }
                });
                
            } catch (error) {
                showError('–û—à–∏–±–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏: ' + error.message);
                console.error('Auth error:', error);
            }
        }

        async function loadUserProfile() {
            if (!currentUser) return;
            
            try {
                const userDoc = await getDoc(doc(db, 'users', currentUser.uid));
                if (userDoc.exists()) {
                    const userData = userDoc.data();
                    populateProfileForm(userData);
                }
            } catch (error) {
                console.error("Error loading user profile:", error);
            }
        }

        async function saveUserProfile() {
            if (!currentUser) return;
            
            const username = document.getElementById('username').value.trim();
            const mainGame = document.getElementById('main-game').value;
            const platform = document.getElementById('platform').value;
            const playTime = document.getElementById('play-time').value;
            const playStyle = document.getElementById('play-style').value;
            const mic = document.getElementById('mic').value;
            const bio = document.getElementById('bio').value.trim();

            if (!username || !mainGame || !platform) {
                showError('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è: –∏–º—è, –∏–≥—Ä—É –∏ –ø–ª–∞—Ç—Ñ–æ—Ä–º—É');
                return;
            }

            hideError();

            try {
                await setDoc(doc(db, 'users', currentUser.uid), {
                    username,
                    mainGame,
                    platform,
                    playTime,
                    playStyle,
                    mic,
                    bio,
                    lastActive: serverTimestamp(),
                    uid: currentUser.uid
                }, { merge: true });

                alert('–ü—Ä–æ—Ñ–∏–ª—å —Å–æ—Ö—Ä–∞–Ω–µ–Ω!');
                switchTab('search');
            } catch (error) {
                showError('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –ø—Ä–æ—Ñ–∏–ª—è: ' + error.message);
                console.error(error);
            }
        }

        function listenForPlayers() {
            if (unsubscribePlayers) {
                unsubscribePlayers();
            }
            
            const playersList = document.getElementById('players-list');
            playersList.innerHTML = '<div class="empty-state"><div class="loader"></div><p>–ü–æ–∏—Å–∫ –∏–≥—Ä–æ–∫–æ–≤...</p></div>';
            
            const q = query(collection(db, 'users'), where('uid', '!=', currentUser.uid));
            
            unsubscribePlayers = onSnapshot(q, (snapshot) => {
                const players = [];
                snapshot.forEach(doc => {
                    players.push({ id: doc.id, ...doc.data() });
                });
                
                displaySearchResults(players);
            }, (error) => {
                showError('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏–≥—Ä–æ–∫–æ–≤: ' + error.message);
                console.error(error);
            });
        }

        function searchPlayers() {
            const game = document.getElementById('search-game').value;
            const platform = document.getElementById('search-platform').value;
            
            const playersList = document.getElementById('players-list');
            playersList.innerHTML = '<div class="empty-state"><div class="loader"></div><p>–ü–æ–∏—Å–∫...</p></div>';
            
            let q = query(collection(db, 'users'), where('uid', '!=', currentUser.uid));
            
            if (game) {
                q = query(q, where('mainGame', '==', game));
            }
            
            if (platform) {
                q = query(q, where('platform', '==', platform));
            }
            
            getDocs(q).then((snapshot) => {
                const players = [];
                snapshot.forEach(doc => {
                    players.push({ id: doc.id, ...doc.data() });
                });
                
                displaySearchResults(players);
            }).catch((error) => {
                showError('–û—à–∏–±–∫–∞ –ø–æ–∏—Å–∫–∞: ' + error.message);
                console.error(error);
            });
        }

        function displaySearchResults(players) {
            const playersList = document.getElementById('players-list');
            
            if (players.length === 0) {
                playersList.innerHTML = `
                    <div class="empty-state">
                        <p>–ò–≥—Ä–æ–∫–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –∏–∑–º–µ–Ω–∏—Ç—å —Ñ–∏–ª—å—Ç—Ä—ã.</p>
                    </div>
                `;
                return;
            }

            playersList.innerHTML = '';
            players.forEach(player => {
                const playerCard = document.createElement('div');
                playerCard.className = 'player-card';
                
                const lastActive = player.lastActive?.toDate ? 
                    new Date(player.lastActive.toDate()) : 
                    new Date();
                const now = new Date();
                const diffMinutes = (now - lastActive) / (1000 * 60);
                const isOnline = diffMinutes < 5;
                
                playerCard.innerHTML = `
                    <h3>${player.username} ${isOnline ? '<span style="color: #2ecc71; font-size: 14px;">‚óè –æ–Ω–ª–∞–π–Ω</span>' : ''}</h3>
                    <div class="player-info">
                        <div><strong>–ò–≥—Ä–∞:</strong> ${getGameName(player.mainGame)}</div>
                        <div><strong>–ü–ª–∞—Ç—Ñ–æ—Ä–º–∞:</strong> ${getPlatformName(player.platform)}</div>
                        <div><strong>–í—Ä–µ–º—è:</strong> ${getPlayTimeName(player.playTime)}</div>
                        <div><strong>–°—Ç–∏–ª—å:</strong> ${getPlayStyleName(player.playStyle)}</div>
                        <div><strong>–ú–∏–∫—Ä–æ—Ñ–æ–Ω:</strong> ${player.mic === 'yes' ? '‚úÖ –ï—Å—Ç—å' : '‚ùå –ù–µ—Ç'}</div>
                    </div>
                    ${player.bio ? `<p><em>${player.bio}</em></p>` : ''}
                `;
                
                playerCard.addEventListener('click', () => {
                    startChatWithPlayer(player);
                });
                
                playersList.appendChild(playerCard);
            });
        }

        function startChatWithPlayer(player) {
            if (!currentUser) return;
            
            currentChatPartner = player;
            document.getElementById('chat-title').textContent = `–ß–∞—Ç —Å ${player.username}`;
            document.getElementById('message-input').disabled = false;
            document.getElementById('send-message').disabled = false;
            
            // Clear chat container
            const chatContainer = document.getElementById('chat-container');
            chatContainer.innerHTML = '<div class="empty-state"><div class="loader"></div><p>–ó–∞–≥—Ä—É–∑–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏–π...</p></div>';
            
            // Setup chat listener
            setupChatListener(currentUser.uid, player.id);
            
            switchTab('chat');
            document.getElementById('message-input').focus();
        }

        function setupChatListener(userId1, userId2) {
            if (unsubscribeChats) {
                unsubscribeChats();
            }
            
            const chatId = [userId1, userId2].sort().join('_');
            const chatContainer = document.getElementById('chat-container');
            
            const messagesRef = collection(db, 'chats', chatId, 'messages');
            const q = query(messagesRef, orderBy('timestamp'));
            
            unsubscribeChats = onSnapshot(q, (snapshot) => {
                chatContainer.innerHTML = '';
                
                if (snapshot.empty) {
                    chatContainer.innerHTML = `
                        <div class="empty-state">
                            <p>–ù–∞—á–Ω–∏—Ç–µ –¥–∏–∞–ª–æ–≥! –û—Ç–ø—Ä–∞–≤—å—Ç–µ –ø–µ—Ä–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ.</p>
                        </div>
                    `;
                    return;
                }
                
                snapshot.forEach(doc => {
                    const msg = doc.data();
                    const messageDiv = document.createElement('div');
                    messageDiv.className = `message ${msg.senderId === currentUser.uid ? 'sent' : 'received'}`;
                    
                    const time = msg.timestamp?.toDate ? new Date(msg.timestamp.toDate()) : new Date();
                    
                    messageDiv.innerHTML = `
                        <div><strong>${msg.senderId === currentUser.uid ? '–í—ã' : msg.senderName}:</strong> ${msg.text}</div>
                        <div style="font-size: 12px; opacity: 0.7; text-align: right;">${time.toLocaleTimeString()}</div>
                    `;
                    chatContainer.appendChild(messageDiv);
                });
                
                // Scroll to bottom
                chatContainer.scrollTop = chatContainer.scrollHeight;
            }, (error) => {
                showError('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —á–∞—Ç–∞: ' + error.message);
                console.error(error);
            });
        }

        async function sendMessage() {
            const messageInput = document.getElementById('message-input');
            const messageText = messageInput.value.trim();
            
            if (!messageText || !currentChatPartner || !currentUser) return;
            
            const chatId = [currentUser.uid, currentChatPartner.id].sort().join('_');
            
            try {
                // Create chat document if it doesn't exist
                const chatRef = doc(db, 'chats', chatId);
                const chatSnap = await getDoc(chatRef);
                if (!chatSnap.exists()) {
                    await setDoc(chatRef, {
                        participants: [currentUser.uid, currentChatPartner.id],
                        createdAt: serverTimestamp()
                    });
                }
                
                // Add message
                await addDoc(collection(db, 'chats', chatId, 'messages'), {
                    text: messageText,
                    senderId: currentUser.uid,
                    senderName: document.getElementById('username').value || '–ò–≥—Ä–æ–∫',
                    timestamp: serverTimestamp(),
                    chatId: chatId
                });
                
                messageInput.value = '';
            } catch (error) {
                showError('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏—è: ' + error.message);
                console.error(error);
            }
        }

        function listenForUserChats() {
            if (!currentUser) return;
            
            const chatsList = document.getElementById('chats-list');
            chatsList.innerHTML = '<div class="empty-state"><div class="loader"></div><p>–ó–∞–≥—Ä—É–∑–∫–∞ —á–∞—Ç–æ–≤...</p></div>';
            
            // Get all chats for current user
            const q = query(collection(db, 'chats'), where('participants', 'array-contains', currentUser.uid));
            
            onSnapshot(q, async (snapshot) => {
                const chatPromises = [];
                
                snapshot.forEach(doc => {
                    const chatData = doc.data();
                    // Get last message
                    const messagesRef = collection(db, 'chats', doc.id, 'messages');
                    const lastMessageQuery = query(messagesRef, orderBy('timestamp', 'desc'), limit(1));
                    
                    const lastMessagePromise = getDocs(lastMessageQuery).then(msgSnapshot => {
                        let lastMessage = null;
                        if (!msgSnapshot.empty) {
                            lastMessage = msgSnapshot.docs[0].data();
                        }
                        return { chatId: doc.id, chatData, lastMessage };
                    });
                    
                    chatPromises.push(lastMessagePromise);
                });
                
                Promise.all(chatPromises).then(chats => {
                    displayUserChats(chats);
                });
            });
        }

        function displayUserChats(chats) {
            const chatsList = document.getElementById('chats-list');
            
            if (chats.length === 0) {
                chatsList.innerHTML = `
                    <div class="empty-state">
                        <p>–£ –≤–∞—Å –ø–æ–∫–∞ –Ω–µ—Ç —á–∞—Ç–æ–≤. –ù–∞–π–¥–∏—Ç–µ –∏–≥—Ä–æ–∫–æ–≤ —á–µ—Ä–µ–∑ –ø–æ–∏—Å–∫!</p>
                    </div>
                `;
                return;
            }

            chatsList.innerHTML = '';
            chats.forEach(chatItem => {
                // Find partner ID
                const partnerId = chatItem.chatData.participants.find(id => id !== currentUser.uid);
                
                // Get partner info
                getDoc(doc(db, 'users', partnerId)).then(partnerDoc => {
                    if (!partnerDoc.exists()) return;
                    
                    const partner = partnerDoc.data();
                    const chatDiv = document.createElement('div');
                    chatDiv.className = 'player-card';
                    
                    chatDiv.innerHTML = `
                        <h3>${partner.username}</h3>
                        <div class="player-info">
                            <div><strong>–ò–≥—Ä–∞:</strong> ${getGameName(partner.mainGame)}</div>
                            <div><strong>–ü–ª–∞—Ç—Ñ–æ—Ä–º–∞:</strong> ${getPlatformName(partner.platform)}</div>
                            ${chatItem.lastMessage ? `
                                <div><strong>–ü–æ—Å–ª–µ–¥–Ω–µ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ:</strong></div>
                                <div><em>${chatItem.lastMessage.text.length > 50 ? chatItem.lastMessage.text.substring(0, 50) + '...' : chatItem.lastMessage.text}</em></div>
                                <div style="font-size: 12px; opacity: 0.7;">${new Date(chatItem.lastMessage.timestamp.toDate()).toLocaleTimeString()}</div>
                            ` : ''}
                        </div>
                    `;
                    
                    chatDiv.addEventListener('click', () => {
                        currentChatPartner = { id: partnerId, ...partner };
                        startChatWithPlayer(currentChatPartner);
                    });
                    
                    chatsList.appendChild(chatDiv);
                });
            });
        }

        // Helper methods to get display names
        function getGameName(gameKey) {
            const games = {
                'baldurs-gate-3': 'Baldur\'s Gate 3',
                'it-takes-two': 'It Takes Two',
                'deep-rock-galactic': 'Deep Rock Galactic',
                'overcooked': 'Overcooked 2',
                'monster-hunter': 'Monster Hunter',
                'elden-ring': 'Elden Ring',
                'other': '–î—Ä—É–≥–∞—è –∏–≥—Ä–∞'
            };
            return games[gameKey] || gameKey;
        }

        function getPlatformName(platformKey) {
            const platforms = {
                'pc': 'PC (Steam/Epic)',
                'ps5': 'PlayStation 5',
                'xbox': 'Xbox Series X/S',
                'switch': 'Nintendo Switch'
            };
            return platforms[platformKey] || platformKey;
        }

        function getPlayTimeName(timeKey) {
            const times = {
                'evenings': '–í–µ—á–µ—Ä–∞ (–ø–æ—Å–ª–µ 19:00)',
                'weekends': '–í—ã—Ö–æ–¥–Ω—ã–µ',
                'flexible': '–ì–∏–±–∫–∏–π –≥—Ä–∞—Ñ–∏–∫'
            };
            return times[timeKey] || timeKey;
        }

        function getPlayStyleName(styleKey) {
            const styles = {
                'casual': '–ö–∞–∑—É–∞–ª (–¥–ª—è —Ñ–∞–Ω–∞)',
                'hardcore': '–•–∞—Ä–¥–∫–æ—Ä (100% –ø—Ä–æ—Ö–æ–∂–¥–µ–Ω–∏–µ)',
                'explorer': '–ò—Å—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å (—Å–æ–±–∏—Ä–∞—é –≤—Å—ë)'
            };
            return styles[styleKey] || styleKey;
        }

        // UI Functions
        function initEventListeners() {
            // Tab switching
            document.querySelectorAll('.tab').forEach(tab => {
                tab.addEventListener('click', () => {
                    switchTab(tab.dataset.tab);
                });
            });

            // Search button
            document.getElementById('search-button').addEventListener('click', () => {
                searchPlayers();
            });

            // Save profile button
            document.getElementById('save-profile').addEventListener('click', () => {
                saveUserProfile();
            });

            // Send message button
            document.getElementById('send-message').addEventListener('click', () => {
                sendMessage();
            });

            // Enter key in message input
            document.getElementById('message-input').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    sendMessage();
                }
            });
        }

        function switchTab(tabName) {
            // Update tabs
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelector(`.tab[data-tab="${tabName}"]`).classList.add('active');

            // Update tab content
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            document.getElementById(`${tabName}-tab`).classList.add('active');

            // Special cases
            if (tabName === 'chat') {
                listenForUserChats();
            } else if (tabName === 'search') {
                listenForPlayers();
            }
        }

        function populateProfileForm(userData) {
            if (!userData) return;
            document.getElementById('username').value = userData.username || '';
            document.getElementById('main-game').value = userData.mainGame || '';
            document.getElementById('platform').value = userData.platform || '';
            document.getElementById('play-time').value = userData.playTime || '';
            document.getElementById('play-style').value = userData.playStyle || '';
            document.getElementById('mic').value = userData.mic || 'yes';
            document.getElementById('bio').value = userData.bio || '';
        }

        // Initialize app when DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            initApp();
        });
    </script>
</body>
</html>
