<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üéÆ Co-op Finder ‚Äî –†–µ–∞–ª—å–Ω—ã–π –ø–æ–∏—Å–∫ –Ω–∞–ø–∞—Ä–Ω–∏–∫–æ–≤</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --bg: #0a0a0a;
            --card-bg: #1a1a1a;
            --accent: #888;
            --accent-light: #aaa;
            --text: #f0f0f0;
            --text-secondary: #ccc;
            --border: rgba(255, 255, 255, 0.1);
            --success: #4CAF50;
            --online: #4CAF50;
            --offline: #ccc;
            --error: #f44336;
            --shadow: 0 4px 12px rgba(0, 0, 0, 0.25);
        }

        .theme-light {
            --bg: #f5f5f5;
            --card-bg: #ffffff;
            --accent: #666;
            --accent-light: #888;
            --text: #333;
            --text-secondary: #666;
            --border: rgba(0, 0, 0, 0.1);
            --shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
        }

        .theme-blue {
            --bg: #0f1a2a;
            --card-bg: #1a2a3a;
            --accent: #4a72b5;
            --accent-light: #6a92d5;
            --text: #e0e8f0;
            --text-secondary: #a0a8b0;
            --border: rgba(100, 150, 255, 0.15);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            transition: background-color 0.3s, color 0.3s, border-color 0.3s;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: var(--bg);
            color: var(--text);
            min-height: 100vh;
            padding: 20px;
            position: relative;
            padding-bottom: 80px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        header {
            text-align: center;
            padding: 20px 0;
            position: relative;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .theme-switcher {
            position: absolute;
            right: 10px;
            top: 20px;
            display: flex;
            gap: 10px;
        }

        .theme-btn {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            cursor: pointer;
            border: 2px solid var(--text);
        }

        .theme-btn.default {
            background: linear-gradient(135deg, #0a0a0a 50%, #1a1a1a 50%);
        }

        .theme-btn.light {
            background: linear-gradient(135deg, #f5f5f5 50%, #ffffff 50%);
        }

        .theme-btn.blue {
            background: linear-gradient(135deg, #0f1a2a 50%, #1a2a3a 50%);
        }

        h1 {
            font-size: 2.5em;
            margin: 0 0 15px;
            color: var(--text);
            position: relative;
            display: inline-block;
        }

        h1::after {
            content: '';
            position: absolute;
            bottom: -5px;
            left: 0;
            width: 100%;
            height: 2px;
            background: var(--accent);
            transform: scaleX(0);
            transform-origin: bottom right;
            transition: transform 0.3s;
        }

        h1:hover::after {
            transform: scaleX(1);
            transform-origin: bottom left;
        }

        .main {
            display: flex;
            gap: 30px;
            flex-wrap: wrap;
        }

        .sidebar {
            flex: 1;
            min-width: 300px;
            background: var(--card-bg);
            border-radius: 15px;
            padding: 20px;
            box-shadow: var(--shadow);
            border: 1px solid var(--border);
        }

        .content {
            flex: 2;
            min-width: 300px;
        }

        .card {
            background: var(--card-bg);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: var(--shadow);
            border: 1px solid var(--border);
            animation: fadeIn 0.5s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .form-group {
            margin-bottom: 15px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: var(--text);
        }

        input, select, textarea {
            width: 100%;
            padding: 12px 15px;
            border-radius: 8px;
            border: 1px solid var(--border);
            background: var(--card-bg);
            color: var(--text);
            font-size: 16px;
            transition: all 0.3s;
        }

        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: var(--accent);
            box-shadow: 0 0 0 2px rgba(136, 136, 136, 0.2);
        }

        button {
            background: var(--accent);
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 8px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 16px;
            margin-right: 10px;
            margin-bottom: 10px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        button:hover {
            background: var(--accent-light);
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        }

        button:active {
            transform: translateY(0);
        }

        .player-list {
            max-height: 400px;
            overflow-y: auto;
            margin-top: 20px;
        }

        .player-card {
            background: rgba(40, 40, 40, 0.5);
            padding: 15px;
            border-radius: 12px;
            margin-bottom: 15px;
            border: 1px solid var(--border);
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .player-card:hover {
            transform: translateX(5px);
            border-color: var(--accent);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }

        .player-avatar {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            object-fit: cover;
            border: 2px solid var(--accent);
        }

        .player-info {
            flex: 1;
        }

        .player-card h3 {
            margin: 0 0 5px;
            color: var(--text);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .player-info-text {
            font-size: 14px;
            color: var(--text-secondary);
            margin-bottom: 5px;
        }

        .chat-container {
            height: 400px;
            background: var(--card-bg);
            border-radius: 12px;
            padding: 15px;
            overflow-y: auto;
            margin-bottom: 15px;
            border: 1px solid var(--border);
            display: flex;
            flex-direction: column;
        }

        .message {
            margin-bottom: 15px;
            padding: 10px 15px;
            border-radius: 12px;
            max-width: 80%;
            word-wrap: break-word;
            align-self: flex-start;
            position: relative;
            animation: messageAppear 0.3s ease;
        }

        @keyframes messageAppear {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .message.sent {
            background: var(--accent);
            color: white;
            margin-left: auto;
            align-self: flex-end;
        }

        .message.received {
            background: rgba(50, 50, 50, 0.5);
        }

        .message-img {
            max-width: 100%;
            border-radius: 8px;
            margin-top: 5px;
            cursor: pointer;
        }

        .chat-input {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .chat-input input {
            flex: 1;
        }

        .tabs {
            display: flex;
            margin-bottom: 20px;
            border-bottom: 1px solid var(--border);
        }

        .tab {
            padding: 10px 20px;
            cursor: pointer;
            border-bottom: 3px solid transparent;
            transition: all 0.3s;
            position: relative;
        }

        .tab.active {
            border-bottom: 3px solid var(--accent);
            color: var(--accent);
            font-weight: bold;
        }

        .tab-content {
            display: none;
            animation: fadeIn 0.5s ease;
        }

        .tab-content.active {
            display: block;
        }

        .profile-section {
            display: none;
        }

        .profile-section.active {
            display: block;
        }

        .empty-state {
            text-align: center;
            padding: 30px 20px;
            color: var(--text-secondary);
        }

        .status {
            text-align: center;
            padding: 10px;
            margin: 10px 0;
            border-radius: 8px;
            font-size: 14px;
        }

        .status.online {
            background: rgba(76, 175, 80, 0.2);
            color: var(--online);
        }

        .status.error {
            background: rgba(244, 67, 54, 0.2);
            color: var(--error);
        }

        .loader {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255,255,255,.3);
            border-radius: 50%;
            border-top-color: var(--accent);
            animation: spin 1s ease-in-out infinite;
            margin: 10px auto;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        #firebase-error {
            background: var(--error);
            color: white;
            padding: 10px;
            border-radius: 8px;
            margin: 10px 0;
            display: none;
            animation: shake 0.5s ease;
        }

        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            20%, 60% { transform: translateX(-5px); }
            40%, 80% { transform: translateX(5px); }
        }

        .avatar-upload {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 20px;
        }

        .avatar-preview {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            object-fit: cover;
            border: 2px solid var(--accent);
        }

        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: var(--card-bg);
            border-top: 1px solid var(--border);
            display: flex;
            justify-content: space-around;
            padding: 12px;
            z-index: 1000;
        }

        .nav-btn {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            background: none;
            border: none;
            color: var(--text-secondary);
            font-size: 12px;
            padding: 8px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .nav-btn.active {
            color: var(--accent);
        }

        .nav-btn i {
            font-size: 20px;
            margin-bottom: 4px;
        }

        .nav-btn:hover {
            color: var(--accent);
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            z-index: 1001;
            align-items: center;
            justify-content: center;
            animation: fadeIn 0.3s ease;
        }

        .modal-content {
            background: var(--card-bg);
            border-radius: 12px;
            padding: 20px;
            max-width: 90%;
            max-height: 90%;
            overflow: auto;
            position: relative;
            animation: scaleIn 0.3s ease;
        }

        @keyframes scaleIn {
            from { transform: scale(0.9); opacity: 0; }
            to { transform: scale(1); opacity: 1; }
        }

        .close-modal {
            position: absolute;
            top: 15px;
            right: 15px;
            font-size: 24px;
            cursor: pointer;
            color: var(--text);
        }

        .image-full {
            max-width: 100%;
            border-radius: 8px;
        }

        .unread-badge {
            background: var(--accent);
            color: white;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            position: absolute;
            top: -5px;
            right: -5px;
        }

        .chat-item {
            position: relative;
        }

        .online-dot {
            width: 10px;
            height: 10px;
            background: var(--online);
            border-radius: 50%;
            display: inline-block;
        }

        .offline-dot {
            width: 10px;
            height: 10px;
            background: var(--offline);
            border-radius: 50%;
            display: inline-block;
        }

        @media (max-width: 768px) {
            .main {
                flex-direction: column;
            }
            
            .sidebar, .content {
                width: 100%;
            }
            
            h1 {
                font-size: 2em;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <div class="theme-switcher">
                <div class="theme-btn default" data-theme="default"></div>
                <div class="theme-btn light" data-theme="light"></div>
                <div class="theme-btn blue" data-theme="blue"></div>
            </div>
            <div>
                <h1>üéÆ Co-op Finder</h1>
                <p>–ù–∞—Å—Ç–æ—è—â–∏–µ –ª—é–¥–∏. –ù–∞—Å—Ç–æ—è—â–∏–µ –∫–æ–æ–ø–µ—Ä–∞—Ç–∏–≤—ã.</p>
            </div>
        </header>

        <div id="firebase-error"></div>
        <div id="auth-status" class="status">–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è...</div>

        <div class="main">
            <div class="sidebar">
                <div class="tabs">
                    <div class="tab active" data-tab="search"><i class="fas fa-search"></i> –ü–æ–∏—Å–∫</div>
                    <div class="tab" data-tab="profile"><i class="fas fa-user"></i> –ü—Ä–æ—Ñ–∏–ª—å</div>
                    <div class="tab" data-tab="chat"><i class="fas fa-comments"></i> –ß–∞—Ç—ã</div>
                </div>

                <div id="search-tab" class="tab-content active">
                    <div class="card">
                        <h2><i class="fas fa-search"></i> –ü–æ–∏—Å–∫ –Ω–∞–ø–∞—Ä–Ω–∏–∫–æ–≤</h2>
                        <div class="form-group">
                            <label for="search-game">–ò–≥—Ä–∞</label>
                            <select id="search-game">
                                <option value="">–õ—é–±–∞—è –∏–≥—Ä–∞</option>
                                <option value="baldurs-gate-3">Baldur's Gate 3</option>
                                <option value="it-takes-two">It Takes Two</option>
                                <option value="deep-rock-galactic">Deep Rock Galactic</option>
                                <option value="overcooked">Overcooked 2</option>
                                <option value="monster-hunter">Monster Hunter</option>
                                <option value="elden-ring">Elden Ring</option>
                                <option value="other">–î—Ä—É–≥–∞—è...</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="search-platform">–ü–ª–∞—Ç—Ñ–æ—Ä–º–∞</label>
                            <select id="search-platform">
                                <option value="">–õ—é–±–∞—è –ø–ª–∞—Ç—Ñ–æ—Ä–º–∞</option>
                                <option value="pc">PC (Steam/Epic)</option>
                                <option value="ps5">PlayStation 5</option>
                                <option value="xbox">Xbox Series X/S</option>
                                <option value="switch">Nintendo Switch</option>
                            </select>
                        </div>
                        <button id="search-button"><i class="fas fa-search"></i> –ù–∞–π—Ç–∏ –∏–≥—Ä–æ–∫–æ–≤</button>
                    </div>

                    <div class="card">
                        <h2><i class="fas fa-users"></i> –ê–∫—Ç–∏–≤–Ω—ã–µ –∏–≥—Ä–æ–∫–∏</h2>
                        <div id="players-list" class="player-list">
                            <div class="empty-state">
                                <div class="loader"></div>
                                <p>–ó–∞–≥—Ä—É–∑–∫–∞ —Å–ø–∏—Å–∫–∞ –∏–≥—Ä–æ–∫–æ–≤...</p>
                            </div>
                        </div>
                    </div>
                </div>

                <div id="profile-tab" class="tab-content">
                    <div class="card">
                        <h2><i class="fas fa-user-edit"></i> –í–∞—à –ø—Ä–æ—Ñ–∏–ª—å</h2>
                        
                        <div class="avatar-upload">
                            <img id="avatar-preview" src="https://via.placeholder.com/80" class="avatar-preview" alt="–ê–≤–∞—Ç–∞—Ä">
                            <div>
                                <input type="file" id="avatar-upload" accept="image/*" style="display: none;">
                                <button id="upload-button"><i class="fas fa-upload"></i> –ó–∞–≥—Ä—É–∑–∏—Ç—å —Ñ–æ—Ç–æ</button>
                                <div class="player-info-text">JPG, PNG –∏–ª–∏ GIF. –ú–∞–∫—Å. 1 –ú–ë</div>
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label for="username">–ò–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</label>
                            <input type="text" id="username" placeholder="–í–∞—à –∏–≥—Ä–æ–≤–æ–π –Ω–∏–∫">
                        </div>
                        <div class="form-group">
                            <label for="main-game">–û—Å–Ω–æ–≤–Ω–∞—è –∏–≥—Ä–∞</label>
                            <select id="main-game">
                                <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –∏–≥—Ä—É</option>
                                <option value="baldurs-gate-3">Baldur's Gate 3</option>
                                <option value="it-takes-two">It Takes Two</option>
                                <option value="deep-rock-galactic">Deep Rock Galactic</option>
                                <option value="overcooked">Overcooked 2</option>
                                <option value="monster-hunter">Monster Hunter</option>
                                <option value="elden-ring">Elden Ring</option>
                                <option value="other">–î—Ä—É–≥–∞—è...</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="platform">–ü–ª–∞—Ç—Ñ–æ—Ä–º–∞</label>
                            <select id="platform">
                                <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –ø–ª–∞—Ç—Ñ–æ—Ä–º—É</option>
                                <option value="pc">PC (Steam/Epic)</option>
                                <option value="ps5">PlayStation 5</option>
                                <option value="xbox">Xbox Series X/S</option>
                                <option value="switch">Nintendo Switch</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="play-time">–ö–æ–≥–¥–∞ –∏–≥—Ä–∞–µ—Ç–µ?</label>
                            <select id="play-time">
                                <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –≤—Ä–µ–º—è</option>
                                <option value="evenings">–í–µ—á–µ—Ä–∞ (–ø–æ—Å–ª–µ 19:00)</option>
                                <option value="weekends">–í—ã—Ö–æ–¥–Ω—ã–µ</option>
                                <option value="flexible">–ì–∏–±–∫–∏–π –≥—Ä–∞—Ñ–∏–∫</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="play-style">–°—Ç–∏–ª—å –∏–≥—Ä—ã</label>
                            <select id="play-style">
                                <option value="">–í—ã–±–µ—Ä–∏—Ç–µ —Å—Ç–∏–ª—å</option>
                                <option value="casual">–ö–∞–∑—É–∞–ª (–¥–ª—è —Ñ–∞–Ω–∞)</option>
                                <option value="hardcore">–•–∞—Ä–¥–∫–æ—Ä (100% –ø—Ä–æ—Ö–æ–∂–¥–µ–Ω–∏–µ)</option>
                                <option value="explorer">–ò—Å—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å (—Å–æ–±–∏—Ä–∞—é –≤—Å—ë)</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="mic">–ú–∏–∫—Ä–æ—Ñ–æ–Ω</label>
                            <select id="mic">
                                <option value="yes">–ï—Å—Ç—å, –≥–æ—Ç–æ–≤ –æ–±—â–∞—Ç—å—Å—è</option>
                                <option value="no">–ù–µ—Ç/–Ω–µ –∏—Å–ø–æ–ª—å–∑—É—é</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="bio">–û —Å–µ–±–µ (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)</label>
                            <textarea id="bio" rows="3" placeholder="–†–∞—Å—Å–∫–∞–∂–∏—Ç–µ –æ —Å–µ–±–µ, —Å–≤–æ–µ–º —Å—Ç–∏–ª–µ –∏–≥—Ä—ã..."></textarea>
                        </div>
                        <button id="save-profile"><i class="fas fa-save"></i> –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –ø—Ä–æ—Ñ–∏–ª—å</button>
                    </div>
                </div>

                <div id="chat-tab" class="tab-content">
                    <div class="card">
                        <h2><i class="fas fa-comments"></i> –í–∞—à–∏ —á–∞—Ç—ã</h2>
                        <div id="chats-list">
                            <div class="empty-state">
                                <div class="loader"></div>
                                <p>–ó–∞–≥—Ä—É–∑–∫–∞ —á–∞—Ç–æ–≤...</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="content">
                <div id="chat-section" class="profile-section active">
                    <div class="card">
                        <h2 id="chat-title"><i class="fas fa-comment-dots"></i> –í—ã–±–µ—Ä–∏—Ç–µ –∏–≥—Ä–æ–∫–∞ –¥–ª—è –Ω–∞—á–∞–ª–∞ —á–∞—Ç–∞</h2>
                        <div id="chat-container" class="chat-container">
                            <div class="empty-state">
                                <p>–í—ã–±–µ—Ä–∏—Ç–µ –∏–≥—Ä–æ–∫–∞ –∏–∑ —Å–ø–∏—Å–∫–∞, —á—Ç–æ–±—ã –Ω–∞—á–∞—Ç—å —á–∞—Ç</p>
                            </div>
                        </div>
                        <div class="chat-input">
                            <input type="text" id="message-input" placeholder="–í–≤–µ–¥–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ..." disabled>
                            <button id="send-message" disabled><i class="fas fa-paper-plane"></i></button>
                            <input type="file" id="image-upload" accept="image/*" style="display: none;">
                            <button id="image-button" disabled><i class="fas fa-image"></i></button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Bottom Navigation -->
    <div class="bottom-nav">
        <div class="nav-btn active" data-tab="search">
            <i class="fas fa-search"></i>
            <span>–ü–æ–∏—Å–∫</span>
        </div>
        <div class="nav-btn" data-tab="profile">
            <i class="fas fa-user"></i>
            <span>–ü—Ä–æ—Ñ–∏–ª—å</span>
        </div>
        <div class="nav-btn" data-tab="chat">
            <i class="fas fa-comments"></i>
            <span>–ß–∞—Ç—ã</span>
        </div>
    </div>

    <!-- Image Modal -->
    <div id="image-modal" class="modal">
        <div class="modal-content">
            <span class="close-modal">&times;</span>
            <img id="modal-image" class="image-full" src="" alt="–£–≤–µ–ª–∏—á–µ–Ω–Ω–æ–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ">
        </div>
    </div>

    <!-- Firebase SDK -->
    <script type="module">
        // Import the functions you need from the SDKs you need
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getAnalytics } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-analytics.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        import { getFirestore, collection, doc, setDoc, getDoc, query, where, onSnapshot, addDoc, orderBy, serverTimestamp, getDocs, limit, updateDoc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
        import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-storage.js";

        // Your web app's Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyAgcGshM7QlRy_lE-jeVvv8X5p9bDORy0w",
            authDomain: "gefd-88f41.firebaseapp.com",
            projectId: "gefd-88f41",
            storageBucket: "gefd-88f41.firebasestorage.app",
            messagingSenderId: "188695764382",
            appId: "1:188695764382:web:df05c7f5cf7aa246e0ca8f",
            measurementId: "G-J1R6XETDES"
        };

        // Initialize Firebase
        let app, auth, db, storage;
        let currentUser = null;
        let currentChatPartner = null;
        let unsubscribePlayers = null;
        let unsubscribeChats = null;
        let unsubscribeMessages = null;

        function showError(message) {
            const errorDiv = document.getElementById('firebase-error');
            errorDiv.textContent = message;
            errorDiv.style.display = 'block';
            document.getElementById('auth-status').textContent = '–û—à–∏–±–∫–∞: ' + message;
            document.getElementById('auth-status').className = 'status error';
            
            // Auto hide error after 5 seconds
            setTimeout(() => {
                errorDiv.style.display = 'none';
            }, 5000);
        }

        function hideError() {
            document.getElementById('firebase-error').style.display = 'none';
        }

        async function initializeFirebase() {
            try {
                document.getElementById('auth-status').textContent = '–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Firebase...';
                
                // Initialize Firebase app
                app = initializeApp(firebaseConfig);
                
                // Get services
                auth = getAuth(app);
                db = getFirestore(app);
                storage = getStorage(app);
                
                // Initialize analytics if available
                try {
                    const analytics = getAnalytics(app);
                } catch (e) {
                    console.log('Analytics not available in this environment');
                }
                
                document.getElementById('auth-status').textContent = 'Firebase –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω! –ù–∞—á–∏–Ω–∞–µ–º –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—é...';
                return true;
            } catch (error) {
                showError('–û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ Firebase: ' + error.message);
                console.error('Firebase initialization error:', error);
                return false;
            }
        }

        // Initialize the app
        async function initApp() {
            // First, initialize Firebase
            const firebaseInitialized = await initializeFirebase();
            if (!firebaseInitialized) {
                return;
            }
            
            try {
                document.getElementById('auth-status').textContent = '–ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è –∞–Ω–æ–Ω–∏–º–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è...';
                
                // Wait for auth state to be ready
                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        // User is signed in
                        currentUser = user;
                        document.getElementById('auth-status').textContent = '–í—ã –≤–æ—à–ª–∏ –∫–∞–∫ –ò–≥—Ä–æ–∫ ' + currentUser.uid.slice(0, 6);
                        document.getElementById('auth-status').className = 'status online';
                        
                        // Load user profile if exists
                        await loadUserProfile();
                        
                        // Setup UI
                        initEventListeners();
                        switchTab('search');
                        
                        // Start listening for players
                        listenForPlayers();
                    } else {
                        // No user is signed in, sign in anonymously
                        try {
                            const userCredential = await signInAnonymously(auth);
                            currentUser = userCredential.user;
                            document.getElementById('auth-status').textContent = '–í—ã –≤–æ—à–ª–∏ –∫–∞–∫ –ò–≥—Ä–æ–∫ ' + currentUser.uid.slice(0, 6);
                            document.getElementById('auth-status').className = 'status online';
                            
                            // Load user profile if exists
                            await loadUserProfile();
                            
                            // Setup UI
                            initEventListeners();
                            switchTab('search');
                            
                            // Start listening for players
                            listenForPlayers();
                        } catch (error) {
                            showError('–û—à–∏–±–∫–∞ –∞–Ω–æ–Ω–∏–º–Ω–æ–π –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏: ' + error.message);
                            console.error('Anonymous sign-in error:', error);
                        }
                    }
                });
                
            } catch (error) {
                showError('–û—à–∏–±–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏: ' + error.message);
                console.error('Auth error:', error);
            }
        }

        async function loadUserProfile() {
            if (!currentUser) return;
            
            try {
                const userDoc = await getDoc(doc(db, 'users', currentUser.uid));
                if (userDoc.exists()) {
                    const userData = userDoc.data();
                    populateProfileForm(userData);
                    
                    // Load avatar if exists
                    if (userData.avatar) {
                        document.getElementById('avatar-preview').src = userData.avatar;
                    }
                }
            } catch (error) {
                console.error("Error loading user profile:", error);
            }
        }

        async function saveUserProfile() {
            if (!currentUser) return;
            
            const username = document.getElementById('username').value.trim();
            const mainGame = document.getElementById('main-game').value;
            const platform = document.getElementById('platform').value;
            const playTime = document.getElementById('play-time').value;
            const playStyle = document.getElementById('play-style').value;
            const mic = document.getElementById('mic').value;
            const bio = document.getElementById('bio').value.trim();

            if (!username || !mainGame || !platform) {
                showError('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è: –∏–º—è, –∏–≥—Ä—É –∏ –ø–ª–∞—Ç—Ñ–æ—Ä–º—É');
                return;
            }

            hideError();

            try {
                await setDoc(doc(db, 'users', currentUser.uid), {
                    username,
                    mainGame,
                    platform,
                    playTime,
                    playStyle,
                    mic,
                    bio,
                    lastActive: serverTimestamp(),
                    uid: currentUser.uid
                }, { merge: true });

                // Show success message
                const statusEl = document.getElementById('auth-status');
                statusEl.textContent = '–ü—Ä–æ—Ñ–∏–ª—å —Å–æ—Ö—Ä–∞–Ω–µ–Ω!';
                statusEl.className = 'status online';
                
                setTimeout(() => {
                    statusEl.textContent = '–í—ã –≤–æ—à–ª–∏ –∫–∞–∫ –ò–≥—Ä–æ–∫ ' + currentUser.uid.slice(0, 6);
                }, 2000);
                
                switchTab('search');
            } catch (error) {
                showError('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –ø—Ä–æ—Ñ–∏–ª—è: ' + error.message);
                console.error(error);
            }
        }

        async function uploadAvatar(file) {
            if (!currentUser || !file) return;
            
            try {
                // Check file size (max 1MB)
                if (file.size > 1024 * 1024) {
                    showError('–§–∞–π–ª —Å–ª–∏—à–∫–æ–º –±–æ–ª—å—à–æ–π. –ú–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π —Ä–∞–∑–º–µ—Ä: 1 –ú–ë');
                    return;
                }
                
                // Upload file to Firebase Storage
                const storageRef = ref(storage, `avatars/${currentUser.uid}`);
                const snapshot = await uploadBytes(storageRef, file);
                const downloadURL = await getDownloadURL(snapshot.ref);
                
                // Update user profile with avatar URL
                await updateDoc(doc(db, 'users', currentUser.uid), {
                    avatar: downloadURL
                });
                
                // Update preview
                document.getElementById('avatar-preview').src = downloadURL;
                
                // Show success message
                const statusEl = document.getElementById('auth-status');
                statusEl.textContent = '–ê–≤–∞—Ç–∞—Ä –æ–±–Ω–æ–≤–ª–µ–Ω!';
                statusEl.className = 'status online';
                
                setTimeout(() => {
                    statusEl.textContent = '–í—ã –≤–æ—à–ª–∏ –∫–∞–∫ –ò–≥—Ä–æ–∫ ' + currentUser.uid.slice(0, 6);
                }, 2000);
                
            } catch (error) {
                showError('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∞–≤–∞—Ç–∞—Ä–∞: ' + error.message);
                console.error(error);
            }
        }

        function listenForPlayers() {
            if (unsubscribePlayers) {
                unsubscribePlayers();
            }
            
            const playersList = document.getElementById('players-list');
            playersList.innerHTML = '<div class="empty-state"><div class="loader"></div><p>–ü–æ–∏—Å–∫ –∏–≥—Ä–æ–∫–æ–≤...</p></div>';
            
            const q = query(collection(db, 'users'), where('uid', '!=', currentUser.uid), orderBy('lastActive', 'desc'));
            
            unsubscribePlayers = onSnapshot(q, (snapshot) => {
                const players = [];
                snapshot.forEach(doc => {
                    players.push({ id: doc.id, ...doc.data() });
                });
                
                displaySearchResults(players);
            }, (error) => {
                showError('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏–≥—Ä–æ–∫–æ–≤: ' + error.message);
                console.error(error);
            });
        }

        function searchPlayers() {
            const game = document.getElementById('search-game').value;
            const platform = document.getElementById('search-platform').value;
            
            const playersList = document.getElementById('players-list');
            playersList.innerHTML = '<div class="empty-state"><div class="loader"></div><p>–ü–æ–∏—Å–∫...</p></div>';
            
            let q = query(collection(db, 'users'), where('uid', '!=', currentUser.uid));
            
            if (game) {
                q = query(q, where('mainGame', '==', game));
            }
            
            if (platform) {
                q = query(q, where('platform', '==', platform));
            }
            
            getDocs(q).then((snapshot) => {
                const players = [];
                snapshot.forEach(doc => {
                    players.push({ id: doc.id, ...doc.data() });
                });
                
                displaySearchResults(players);
            }).catch((error) => {
                showError('–û—à–∏–±–∫–∞ –ø–æ–∏—Å–∫–∞: ' + error.message);
                console.error(error);
            });
        }

        function displaySearchResults(players) {
            const playersList = document.getElementById('players-list');
            
            if (players.length === 0) {
                playersList.innerHTML = `
                    <div class="empty-state">
                        <p>–ò–≥—Ä–æ–∫–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –∏–∑–º–µ–Ω–∏—Ç—å —Ñ–∏–ª—å—Ç—Ä—ã.</p>
                    </div>
                `;
                return;
            }

            playersList.innerHTML = '';
            players.forEach(player => {
                const playerCard = document.createElement('div');
                playerCard.className = 'player-card';
                
                const lastActive = player.lastActive?.toDate ? 
                    new Date(player.lastActive.toDate()) : 
                    new Date();
                const now = new Date();
                const diffMinutes = (now - lastActive) / (1000 * 60);
                const isOnline = diffMinutes < 5;
                
                playerCard.innerHTML = `
                    <img src="${player.avatar || 'https://via.placeholder.com/50'}" class="player-avatar" alt="${player.username}">
                    <div class="player-info">
                        <h3>${player.username} <span class="${isOnline ? 'online-dot' : 'offline-dot'}"></span></h3>
                        <div class="player-info-text">
                            <div><strong>–ò–≥—Ä–∞:</strong> ${getGameName(player.mainGame)}</div>
                            <div><strong>–ü–ª–∞—Ç—Ñ–æ—Ä–º–∞:</strong> ${getPlatformName(player.platform)}</div>
                            <div><strong>–í—Ä–µ–º—è:</strong> ${getPlayTimeName(player.playTime)}</div>
                        </div>
                    </div>
                `;
                
                playerCard.addEventListener('click', () => {
                    startChatWithPlayer(player);
                });
                
                playersList.appendChild(playerCard);
            });
        }

        function startChatWithPlayer(player) {
            if (!currentUser) return;
            
            currentChatPartner = player;
            document.getElementById('chat-title').textContent = `–ß–∞—Ç —Å ${player.username}`;
            document.getElementById('message-input').disabled = false;
            document.getElementById('send-message').disabled = false;
            document.getElementById('image-button').disabled = false;
            
            // Clear chat container
            const chatContainer = document.getElementById('chat-container');
            chatContainer.innerHTML = '<div class="empty-state"><div class="loader"></div><p>–ó–∞–≥—Ä—É–∑–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏–π...</p></div>';
            
            // Setup chat listener
            setupChatListener(currentUser.uid, player.id);
            
            switchTab('chat');
            document.getElementById('message-input').focus();
        }

        function setupChatListener(userId1, userId2) {
            if (unsubscribeMessages) {
                unsubscribeMessages();
            }
            
            const chatId = [userId1, userId2].sort().join('_');
            const chatContainer = document.getElementById('chat-container');
            
            const messagesRef = collection(db, 'chats', chatId, 'messages');
            const q = query(messagesRef, orderBy('timestamp'));
            
            unsubscribeMessages = onSnapshot(q, (snapshot) => {
                chatContainer.innerHTML = '';
                
                if (snapshot.empty) {
                    chatContainer.innerHTML = `
                        <div class="empty-state">
                            <p>–ù–∞—á–Ω–∏—Ç–µ –¥–∏–∞–ª–æ–≥! –û—Ç–ø—Ä–∞–≤—å—Ç–µ –ø–µ—Ä–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ.</p>
                        </div>
                    `;
                    return;
                }
                
                snapshot.forEach(doc => {
                    const msg = doc.data();
                    const messageDiv = document.createElement('div');
                    messageDiv.className = `message ${msg.senderId === currentUser.uid ? 'sent' : 'received'}`;
                    
                    const time = msg.timestamp?.toDate ? new Date(msg.timestamp.toDate()) : new Date();
                    
                    let messageContent = `
                        <div><strong>${msg.senderId === currentUser.uid ? '–í—ã' : msg.senderName}:</strong> ${msg.text}</div>
                    `;
                    
                    if (msg.imageUrl) {
                        messageContent += `
                            <img src="${msg.imageUrl}" class="message-img" alt="–ü—Ä–∏–∫—Ä–µ–ø–ª–µ–Ω–Ω–æ–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ" onclick="openImageModal('${msg.imageUrl}')">
                        `;
                    }
                    
                    messageContent += `
                        <div style="font-size: 12px; opacity: 0.7; text-align: right;">${time.toLocaleTimeString()}</div>
                    `;
                    
                    messageDiv.innerHTML = messageContent;
                    chatContainer.appendChild(messageDiv);
                });
                
                // Scroll to bottom
                chatContainer.scrollTop = chatContainer.scrollHeight;
            }, (error) => {
                showError('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —á–∞—Ç–∞: ' + error.message);
                console.error(error);
            });
        }

        async function sendMessage() {
            const messageInput = document.getElementById('message-input');
            const messageText = messageInput.value.trim();
            
            if (!messageText || !currentChatPartner || !currentUser) return;
            
            const chatId = [currentUser.uid, currentChatPartner.id].sort().join('_');
            
            try {
                // Create chat document if it doesn't exist
                const chatRef = doc(db, 'chats', chatId);
                const chatSnap = await getDoc(chatRef);
                if (!chatSnap.exists()) {
                    await setDoc(chatRef, {
                        participants: [currentUser.uid, currentChatPartner.id],
                        participantNames: {
                            [currentUser.uid]: document.getElementById('username').value || '–ò–≥—Ä–æ–∫',
                            [currentChatPartner.id]: currentChatPartner.username
                        },
                        lastMessage: messageText,
                        lastMessageTime: serverTimestamp(),
                        createdAt: serverTimestamp()
                    });
                } else {
                    // Update last message and time
                    await updateDoc(chatRef, {
                        lastMessage: messageText,
                        lastMessageTime: serverTimestamp()
                    });
                }
                
                // Add message
                await addDoc(collection(db, 'chats', chatId, 'messages'), {
                    text: messageText,
                    senderId: currentUser.uid,
                    senderName: document.getElementById('username').value || '–ò–≥—Ä–æ–∫',
                    timestamp: serverTimestamp(),
                    chatId: chatId
                });
                
                messageInput.value = '';
            } catch (error) {
                showError('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏—è: ' + error.message);
                console.error(error);
            }
        }

        async function sendImage(file) {
            if (!currentChatPartner || !currentUser || !file) return;
            
            try {
                // Check file size (max 5MB)
                if (file.size > 5 * 1024 * 1024) {
                    showError('–§–∞–π–ª —Å–ª–∏—à–∫–æ–º –±–æ–ª—å—à–æ–π. –ú–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π —Ä–∞–∑–º–µ—Ä: 5 –ú–ë');
                    return;
                }
                
                const chatId = [currentUser.uid, currentChatPartner.id].sort().join('_');
                
                // Upload file to Firebase Storage
                const storageRef = ref(storage, `chats/${chatId}/${Date.now()}_${file.name}`);
                const snapshot = await uploadBytes(storageRef, file);
                const downloadURL = await getDownloadURL(snapshot.ref);
                
                // Create chat document if it doesn't exist
                const chatRef = doc(db, 'chats', chatId);
                const chatSnap = await getDoc(chatRef);
                if (!chatSnap.exists()) {
                    await setDoc(chatRef, {
                        participants: [currentUser.uid, currentChatPartner.id],
                        participantNames: {
                            [currentUser.uid]: document.getElementById('username').value || '–ò–≥—Ä–æ–∫',
                            [currentChatPartner.id]: currentChatPartner.username
                        },
                        lastMessage: 'üì∑ –ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ',
                        lastMessageTime: serverTimestamp(),
                        createdAt: serverTimestamp()
                    });
                } else {
                    // Update last message and time
                    await updateDoc(chatRef, {
                        lastMessage: 'üì∑ –ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ',
                        lastMessageTime: serverTimestamp()
                    });
                }
                
                // Add message with image
                await addDoc(collection(db, 'chats', chatId, 'messages'), {
                    text: '',
                    imageUrl: downloadURL,
                    senderId: currentUser.uid,
                    senderName: document.getElementById('username').value || '–ò–≥—Ä–æ–∫',
                    timestamp: serverTimestamp(),
                    chatId: chatId
                });
                
            } catch (error) {
                showError('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è: ' + error.message);
                console.error(error);
            }
        }

        function listenForUserChats() {
            if (!currentUser) return;
            
            const chatsList = document.getElementById('chats-list');
            chatsList.innerHTML = '<div class="empty-state"><div class="loader"></div><p>–ó–∞–≥—Ä—É–∑–∫–∞ —á–∞—Ç–æ–≤...</p></div>';
            
            // Get all chats for current user
            const q = query(collection(db, 'chats'), where('participants', 'array-contains', currentUser.uid), orderBy('lastMessageTime', 'desc'));
            
            onSnapshot(q, async (snapshot) => {
                const chats = [];
                
                snapshot.forEach(doc => {
                    const chatData = doc.data();
                    chats.push({ id: doc.id, chatData });
                });
                
                displayUserChats(chats);
            }, (error) => {
                showError('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —á–∞—Ç–æ–≤: ' + error.message);
                console.error(error);
            });
        }

        function displayUserChats(chats) {
            const chatsList = document.getElementById('chats-list');
            
            if (chats.length === 0) {
                chatsList.innerHTML = `
                    <div class="empty-state">
                        <p>–£ –≤–∞—Å –ø–æ–∫–∞ –Ω–µ—Ç —á–∞—Ç–æ–≤. –ù–∞–π–¥–∏—Ç–µ –∏–≥—Ä–æ–∫–æ–≤ —á–µ—Ä–µ–∑ –ø–æ–∏—Å–∫!</p>
                    </div>
                `;
                return;
            }

            chatsList.innerHTML = '';
            chats.forEach(chatItem => {
                // Find partner ID
                const partnerId = chatItem.chatData.participants.find(id => id !== currentUser.uid);
                const partnerName = chatItem.chatData.participantNames?.[partnerId] || '–ò–≥—Ä–æ–∫';
                
                const chatDiv = document.createElement('div');
                chatDiv.className = 'player-card chat-item';
                
                // Get last message time
                const lastMessageTime = chatItem.chatData.lastMessageTime?.toDate ? 
                    new Date(chatItem.chatData.lastMessageTime.toDate()) : 
                    new Date();
                
                const now = new Date();
                const diffMinutes = (now - lastMessageTime) / (1000 * 60);
                let timeText;
                
                if (diffMinutes < 60) {
                    timeText = `${Math.floor(diffMinutes)} –º–∏–Ω –Ω–∞–∑–∞–¥`;
                } else if (diffMinutes < 1440) {
                    timeText = `${Math.floor(diffMinutes / 60)} —á –Ω–∞–∑–∞–¥`;
                } else {
                    timeText = lastMessageTime.toLocaleDateString();
                }
                
                chatDiv.innerHTML = `
                    <img src="https://via.placeholder.com/50" class="player-avatar" alt="${partnerName}">
                    <div class="player-info">
                        <h3>${partnerName}</h3>
                        <div class="player-info-text">
                            <div>${chatItem.chatData.lastMessage || '–ù–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–π'}</div>
                            <div style="font-size: 12px; opacity: 0.7;">${timeText}</div>
                        </div>
                    </div>
                `;
                
                chatDiv.addEventListener('click', () => {
                    // Get partner info from Firestore
                    getDoc(doc(db, 'users', partnerId)).then(partnerDoc => {
                        if (!partnerDoc.exists()) return;
                        
                        const partner = { id: partnerId, ...partnerDoc.data() };
                        currentChatPartner = partner;
                        startChatWithPlayer(partner);
                    });
                });
                
                chatsList.appendChild(chatDiv);
            });
        }

        // Helper methods to get display names
        function getGameName(gameKey) {
            const games = {
                'baldurs-gate-3': 'Baldur\'s Gate 3',
                'it-takes-two': 'It Takes Two',
                'deep-rock-galactic': 'Deep Rock Galactic',
                'overcooked': 'Overcooked 2',
                'monster-hunter': 'Monster Hunter',
                'elden-ring': 'Elden Ring',
                'other': '–î—Ä—É–≥–∞—è –∏–≥—Ä–∞'
            };
            return games[gameKey] || gameKey;
        }

        function getPlatformName(platformKey) {
            const platforms = {
                'pc': 'PC (Steam/Epic)',
                'ps5': 'PlayStation 5',
                'xbox': 'Xbox Series X/S',
                'switch': 'Nintendo Switch'
            };
            return platforms[platformKey] || platformKey;
        }

        function getPlayTimeName(timeKey) {
            const times = {
                'evenings': '–í–µ—á–µ—Ä–∞ (–ø–æ—Å–ª–µ 19:00)',
                'weekends': '–í—ã—Ö–æ–¥–Ω—ã–µ',
                'flexible': '–ì–∏–±–∫–∏–π –≥—Ä–∞—Ñ–∏–∫'
            };
            return times[timeKey] || timeKey;
        }

        function getPlayStyleName(styleKey) {
            const styles = {
                'casual': '–ö–∞–∑—É–∞–ª (–¥–ª—è —Ñ–∞–Ω–∞)',
                'hardcore': '–•–∞—Ä–¥–∫–æ—Ä (100% –ø—Ä–æ—Ö–æ–∂–¥–µ–Ω–∏–µ)',
                'explorer': '–ò—Å—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å (—Å–æ–±–∏—Ä–∞—é –≤—Å—ë)'
            };
            return styles[styleKey] || styleKey;
        }

        // UI Functions
        function initEventListeners() {
            // Tab switching
            document.querySelectorAll('.tab').forEach(tab => {
                tab.addEventListener('click', () => {
                    switchTab(tab.dataset.tab);
                });
            });

            // Bottom nav switching
            document.querySelectorAll('.nav-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    switchTab(btn.dataset.tab);
                    
                    // Update active state
                    document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                });
            });

            // Theme switching
            document.querySelectorAll('.theme-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    document.body.className = '';
                    document.body.classList.add(`theme-${btn.dataset.theme}`);
                });
            });

            // Search button
            document.getElementById('search-button').addEventListener('click', () => {
                searchPlayers();
            });

            // Save profile button
            document.getElementById('save-profile').addEventListener('click', () => {
                saveUserProfile();
            });

            // Upload avatar button
            document.getElementById('upload-button').addEventListener('click', () => {
                document.getElementById('avatar-upload').click();
            });

            document.getElementById('avatar-upload').addEventListener('change', (e) => {
                if (e.target.files && e.target.files[0]) {
                    const reader = new FileReader();
                    reader.onload = function(event) {
                        document.getElementById('avatar-preview').src = event.target.result;
                    };
                    reader.readAsDataURL(e.target.files[0]);
                    
                    uploadAvatar(e.target.files[0]);
                }
            });

            // Send message button
            document.getElementById('send-message').addEventListener('click', () => {
                sendMessage();
            });

            // Send image button
            document.getElementById('image-button').addEventListener('click', () => {
                document.getElementById('image-upload').click();
            });

            document.getElementById('image-upload').addEventListener('change', (e) => {
                if (e.target.files && e.target.files[0]) {
                    sendImage(e.target.files[0]);
                }
            });

            // Enter key in message input
            document.getElementById('message-input').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    sendMessage();
                }
            });

            // Modal close button
            document.querySelector('.close-modal').addEventListener('click', () => {
                document.getElementById('image-modal').style.display = 'none';
            });

            // Close modal when clicking outside
            window.addEventListener('click', (e) => {
                if (e.target === document.getElementById('image-modal')) {
                    document.getElementById('image-modal').style.display = 'none';
                }
            });
        }

        function switchTab(tabName) {
            // Update tabs
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelector(`.tab[data-tab="${tabName}"]`).classList.add('active');

            // Update tab content
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            document.getElementById(`${tabName}-tab`).classList.add('active');

            // Special cases
            if (tabName === 'chat') {
                listenForUserChats();
            } else if (tabName === 'search') {
                listenForPlayers();
            }
        }

        function populateProfileForm(userData) {
            if (!userData) return;
            document.getElementById('username').value = userData.username || '';
            document.getElementById('main-game').value = userData.mainGame || '';
            document.getElementById('platform').value = userData.platform || '';
            document.getElementById('play-time').value = userData.playTime || '';
            document.getElementById('play-style').value = userData.playStyle || '';
            document.getElementById('mic').value = userData.mic || 'yes';
            document.getElementById('bio').value = userData.bio || '';
        }

        // Global function to open image modal
        window.openImageModal = function(imageUrl) {
            document.getElementById('modal-image').src = imageUrl;
            document.getElementById('image-modal').style.display = 'flex';
        };

        // Initialize app when DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            initApp();
        });
    </script>
</body>
        </html>
