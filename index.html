<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Чат-Рулетка</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background: linear-gradient(135deg, #000000 0%, #1a1a1a 100%);
            color: #ffffff;
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 15px;
        }

        .container {
            width: 100%;
            max-width: 1000px;
            background: #000000;
            border-radius: 20px;
            box-shadow: 0 25px 50px rgba(0, 0, 0, 0.5);
            overflow: hidden;
            display: flex;
            flex-direction: column;
            height: 90vh;
            border: 1px solid #333;
        }

        .header {
            background: linear-gradient(90deg, #000000, #222222);
            color: #ffffff;
            padding: 20px;
            text-align: center;
            position: relative;
            border-bottom: 2px solid #333;
        }

        .header h1 {
            font-size: 1.8rem;
            margin-bottom: 5px;
            background: linear-gradient(90deg, #ffffff, #cccccc);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .header p {
            opacity: 0.8;
            font-size: 0.9rem;
        }

        .content {
            display: flex;
            flex: 1;
            overflow: hidden;
        }

        .sidebar {
            width: 260px;
            background: #111111;
            border-right: 1px solid #333;
            padding: 20px;
            display: flex;
            flex-direction: column;
            transition: all 0.3s ease;
            overflow-y: auto;
        }

        .profile-section {
            background: #1a1a1a;
            border-radius: 15px;
            padding: 18px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            margin-bottom: 20px;
            border: 1px solid #333;
            animation: fadeInUp 0.5s ease;
        }

        .profile-section h3 {
            color: #ffffff;
            margin-bottom: 15px;
            font-size: 1.2rem;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .profile-section h3 i {
            color: #4A90E2;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 6px;
            font-weight: 500;
            color: #cccccc;
            font-size: 0.9rem;
        }

        .form-group select, .form-group input {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid #333;
            border-radius: 8px;
            font-size: 0.95rem;
            background: #222222;
            color: #ffffff;
            transition: all 0.3s ease;
        }

        .form-group select:focus, .form-group input:focus {
            outline: none;
            border-color: #4A90E2;
            box-shadow: 0 0 0 2px rgba(74, 144, 226, 0.2);
        }

        .btn {
            background: linear-gradient(90deg, #4A90E2, #5E60CE);
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
            width: 100%;
            font-size: 1rem;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            box-shadow: 0 4px 10px rgba(74, 144, 226, 0.3);
            margin-bottom: 12px;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 15px rgba(74, 144, 226, 0.4);
        }

        .btn:active {
            transform: translateY(-1px);
        }

        .btn-disconnect {
            background: linear-gradient(90deg, #ff416c, #ff4b2b);
            box-shadow: 0 4px 10px rgba(255, 65, 108, 0.3);
        }

        .btn-disconnect:hover {
            box-shadow: 0 6px 15px rgba(255, 65, 108, 0.4);
        }

        .btn-next {
            background: linear-gradient(90deg, #FF9500, #FF5E3A);
            box-shadow: 0 4px 10px rgba(255, 149, 0, 0.3);
        }

        .btn-next:hover {
            box-shadow: 0 6px 15px rgba(255, 149, 0, 0.4);
        }

        .chat-area {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: #0a0a0a;
        }

        .chat-header {
            background: #111111;
            padding: 15px 20px;
            border-bottom: 1px solid #333;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .partner-info {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .status-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #4CAF50;
            box-shadow: 0 0 8px #4CAF50;
        }

        .partner-details h3 {
            font-size: 1.1rem;
            margin-bottom: 2px;
        }

        .partner-details p {
            color: #888;
            font-size: 0.85rem;
        }

        .chat-messages {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
            background: #0a0a0a;
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .message {
            max-width: 75%;
            padding: 12px 16px;
            border-radius: 16px;
            position: relative;
            animation: fadeIn 0.3s ease;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
            line-height: 1.4;
            font-size: 0.95rem;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        @keyframes fadeInUp {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .received {
            background: #222222;
            border-top-left-radius: 5px;
            align-self: flex-start;
            border: 1px solid #333;
        }

        .sent {
            background: linear-gradient(90deg, #4A90E2, #5E60CE);
            color: white;
            border-top-right-radius: 5px;
            margin-left: auto;
            border: 1px solid rgba(74, 144, 226, 0.3);
        }

        .system-message {
            background: #333333 !important;
            color: #aaa !important;
            align-self: center;
            text-align: center;
            font-size: 0.85rem;
            max-width: 80%;
            font-style: italic;
            border: 1px solid #444;
        }

        .chat-input {
            padding: 15px;
            background: #111111;
            border-top: 1px solid #333;
            display: flex;
            gap: 12px;
        }

        .chat-input input {
            flex: 1;
            padding: 12px 16px;
            border: 1px solid #333;
            border-radius: 25px;
            font-size: 1rem;
            background: #222222;
            color: #ffffff;
            transition: all 0.3s ease;
        }

        .chat-input input:focus {
            outline: none;
            border-color: #4A90E2;
            box-shadow: 0 0 0 2px rgba(74, 144, 226, 0.2);
        }

        .chat-input button {
            background: linear-gradient(90deg, #4A90E2, #5E60CE);
            color: white;
            border: none;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 1.2rem;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
            box-shadow: 0 4px 10px rgba(74, 144, 226, 0.3);
        }

        .chat-input button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 15px rgba(74, 144, 226, 0.4);
        }

        .connecting-screen {
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            height: 100%;
            padding: 20px;
            text-align: center;
            background: #0a0a0a;
        }

        .spinner {
            width: 50px;
            height: 50px;
            border: 4px solid rgba(74, 144, 226, 0.2);
            border-top: 4px solid #4A90E2;
            border-radius: 50%;
            animation: spin 1.5s linear infinite;
            margin-bottom: 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .hidden {
            display: none;
        }

        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 20px;
            border-radius: 10px;
            color: white;
            font-weight: 500;
            box-shadow: 0 8px 20px rgba(0,0,0,0.3);
            z-index: 1000;
            animation: slideIn 0.4s ease;
            display: flex;
            align-items: center;
            gap: 10px;
            border-left: 4px solid;
            font-size: 0.9rem;
            max-width: 300px;
        }

        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        .notification.success { 
            background: #2E7D32; 
            border-left-color: #4CAF50;
        }
        .notification.error { 
            background: #C62828; 
            border-left-color: #F44336;
        }
        .notification.info { 
            background: #1565C0; 
            border-left-color: #2196F3;
        }

        .connection-section {
            margin-top: auto;
        }

        .region-tag {
            background: #4A90E2;
            color: white;
            padding: 2px 8px;
            border-radius: 15px;
            font-size: 0.75rem;
        }

        .chat-controls {
            display: flex;
            gap: 10px;
            padding: 10px 15px;
            background: #111111;
            border-top: 1px solid #333;
        }

        .chat-controls .btn {
            margin-bottom: 0;
            padding: 10px 15px;
            font-size: 0.9rem;
        }

        /* Мобильная адаптация */
        @media (max-width: 768px) {
            body {
                padding: 10px;
            }
            
            .container {
                height: 95vh;
                border-radius: 15px;
            }
            
            .header {
                padding: 15px;
            }
            
            .header h1 {
                font-size: 1.5rem;
            }
            
            .header p {
                font-size: 0.8rem;
            }
            
            .content {
                flex-direction: column;
            }
            
            .sidebar {
                width: 100%;
                border-right: none;
                border-bottom: 1px solid #333;
                padding: 15px;
            }
            
            .profile-section {
                padding: 15px;
            }
            
            .profile-section h3 {
                font-size: 1.1rem;
            }
            
            .btn {
                padding: 10px 15px;
                font-size: 0.95rem;
            }
            
            .chat-header {
                padding: 12px 15px;
            }
            
            .partner-details h3 {
                font-size: 1rem;
            }
            
            .partner-details p {
                font-size: 0.8rem;
            }
            
            .chat-messages {
                padding: 15px;
                gap: 10px;
            }
            
            .message {
                max-width: 85%;
                padding: 10px 14px;
                font-size: 0.9rem;
            }
            
            .chat-input {
                padding: 12px;
                gap: 10px;
            }
            
            .chat-input input {
                padding: 10px 14px;
                font-size: 0.95rem;
            }
            
            .chat-input button {
                width: 45px;
                height: 45px;
                font-size: 1.1rem;
            }
            
            .connecting-screen h2 {
                font-size: 1.3rem;
            }
            
            .connecting-screen p {
                font-size: 0.9rem;
            }
            
            .chat-controls {
                padding: 8px 12px;
                gap: 8px;
            }
            
            .chat-controls .btn {
                padding: 8px 12px;
                font-size: 0.85rem;
            }
        }

        @media (max-width: 480px) {
            .container {
                height: 100vh;
                border-radius: 0;
            }
            
            .header {
                padding: 12px;
            }
            
            .header h1 {
                font-size: 1.3rem;
            }
            
            .sidebar {
                padding: 12px;
            }
            
            .profile-section {
                padding: 12px;
            }
            
            .form-group label {
                font-size: 0.85rem;
            }
            
            .form-group select, .form-group input {
                font-size: 0.9rem;
                padding: 8px 10px;
            }
            
            .btn {
                padding: 10px;
                font-size: 0.9rem;
            }
            
            .chat-header {
                padding: 10px 12px;
            }
            
            .partner-info {
                gap: 8px;
            }
            
            .status-indicator {
                width: 10px;
                height: 10px;
            }
            
            .partner-details h3 {
                font-size: 0.95rem;
            }
            
            .partner-details p {
                font-size: 0.75rem;
            }
            
            .region-tag {
                font-size: 0.7rem;
                padding: 1px 6px;
            }
            
            .chat-messages {
                padding: 12px;
            }
            
            .message {
                max-width: 90%;
                padding: 8px 12px;
                font-size: 0.85rem;
            }
            
            .system-message {
                font-size: 0.8rem;
            }
            
            .chat-input {
                padding: 10px;
            }
            
            .chat-input input {
                padding: 8px 12px;
                font-size: 0.9rem;
            }
            
            .chat-input button {
                width: 40px;
                height: 40px;
                font-size: 1rem;
            }
            
            .notification {
                top: 15px;
                right: 15px;
                padding: 12px 15px;
                font-size: 0.85rem;
                max-width: 250px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1><i class="fas fa-globe"></i> Чат-Рулетка</h1>
            <p>Общайтесь с людьми из вашего региона</p>
        </div>
        
        <div class="content">
            <div class="sidebar">
                <div class="profile-section">
                    <h3><i class="fas fa-user"></i> Мой профиль</h3>
                    <div class="form-group">
                        <label for="username"><i class="fas fa-signature"></i> Имя пользователя</label>
                        <input type="text" id="username" placeholder="Введите ваше имя">
                    </div>
                    <div class="form-group">
                        <label for="region"><i class="fas fa-map-marker-alt"></i> Регион</label>
                        <select id="region">
                            <option value="">Выберите регион</option>
                            <optgroup label="Россия">
                                <option value="Москва">Москва</option>
                                <option value="Санкт-Петербург">Санкт-Петербург</option>
                                <option value="Новосибирск">Новосибирск</option>
                                <option value="Екатеринбург">Екатеринбург</option>
                                <option value="Казань">Казань</option>
                                <option value="Нижний Новгород">Нижний Новгород</option>
                                <option value="Челябинск">Челябинск</option>
                                <option value="Самара">Самара</option>
                                <option value="Омск">Омск</option>
                                <option value="Ростов-на-Дону">Ростов-на-Дону</option>
                                <option value="Уфа">Уфа</option>
                                <option value="Красноярск">Красноярск</option>
                                <option value="Воронеж">Воронеж</option>
                                <option value="Пермь">Пермь</option>
                                <option value="Волгоград">Волгоград</option>
                            </optgroup>
                            <optgroup label="Украина">
                                <option value="Киев">Киев</option>
                                <option value="Харьков">Харьков</option>
                                <option value="Одесса">Одесса</option>
                                <option value="Днепр">Днепр</option>
                                <option value="Донецк">Донецк</option>
                                <option value="Запорожье">Запорожье</option>
                                <option value="Львов">Львов</option>
                                <option value="Кривой Рог">Кривой Рог</option>
                                <option value="Николаев">Николаев</option>
                                <option value="Мариуполь">Мариуполь</option>
                            </optgroup>
                            <optgroup label="Беларусь">
                                <option value="Минск">Минск</option>
                                <option value="Гомель">Гомель</option>
                                <option value="Могилев">Могилев</option>
                                <option value="Витебск">Витебск</option>
                                <option value="Гродно">Гродно</option>
                                <option value="Брест">Брест</option>
                            </optgroup>
                            <optgroup label="Казахстан">
                                <option value="Алматы">Алматы</option>
                                <option value="Нур-Султан">Нур-Султан</option>
                                <option value="Шымкент">Шымкент</option>
                                <option value="Караганда">Караганда</option>
                                <option value="Актобе">Актобе</option>
                                <option value="Тараз">Тараз</option>
                                <option value="Павлодар">Павлодар</option>
                                <option value="Усть-Каменогорск">Усть-Каменогорск</option>
                                <option value="Семей">Семей</option>
                            </optgroup>
                        </select>
                    </div>
                    <button id="saveProfile" class="btn">
                        <i class="fas fa-save"></i> Сохранить профиль
                    </button>
                </div>
                
                <div class="connection-section">
                    <button id="connectBtn" class="btn">
                        <i class="fas fa-handshake"></i> Найти собеседника
                    </button>
                    <button id="disconnectBtn" class="btn btn-disconnect hidden">
                        <i class="fas fa-plug"></i> Отключиться
                    </button>
                </div>
            </div>
            
            <div class="chat-area">
                <div id="connectingScreen" class="connecting-screen">
                    <div class="spinner"></div>
                    <h2><i class="fas fa-search"></i> Поиск собеседника...</h2>
                    <p>Ищем пользователя в вашем регионе</p>
                </div>
                
                <div id="chatScreen" class="hidden">
                    <div class="chat-header">
                        <div class="partner-info">
                            <div class="status-indicator"></div>
                            <div class="partner-details">
                                <h3 id="partnerName">Собеседник</h3>
                                <p id="partnerRegion">Регион не указан</p>
                            </div>
                        </div>
                        <div class="region-tag" id="currentUserRegion">Ваш регион</div>
                    </div>
                    
                    <div class="chat-messages" id="messagesContainer">
                        <div class="message system-message">
                            <i class="fas fa-info-circle"></i> Добро пожаловать в Чат-Рулетку! Начните общение.
                        </div>
                    </div>
                    
                    <div class="chat-input">
                        <input type="text" id="messageInput" placeholder="Введите сообщение...">
                        <button id="sendBtn">
                            <i class="fas fa-paper-plane"></i>
                        </button>
                    </div>
                    
                    <div class="chat-controls">
                        <button id="nextBtn" class="btn btn-next">
                            <i class="fas fa-user-friends"></i> Следующий
                        </button>
                        <button id="disconnectChatBtn" class="btn btn-disconnect">
                            <i class="fas fa-times"></i> Отключиться
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyAgcGshM7QlRy_lE-jeVvv8X5p9bDORy0w",
            authDomain: "gefd-88f41.firebaseapp.com",
            databaseURL: "https://gefd-88f41-default-rtdb.firebaseio.com",
            projectId: "gefd-88f41",
            storageBucket: "gefd-88f41.firebasestorage.app",
            messagingSenderId: "188695764382",
            appId: "1:188695764382:web:df05c7f5cf7aa246e0ca8f",
            measurementId: "G-J1R6XETDES"
        };

        // Initialize Firebase
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getDatabase, ref, set, push, onValue, off, remove, get } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js";

        const app = initializeApp(firebaseConfig);
        const database = getDatabase(app);
        console.log("Firebase initialized successfully");

        // DOM Elements
        const usernameInput = document.getElementById('username');
        const regionSelect = document.getElementById('region');
        const saveProfileBtn = document.getElementById('saveProfile');
        const connectBtn = document.getElementById('connectBtn');
        const disconnectBtn = document.getElementById('disconnectBtn');
        const disconnectChatBtn = document.getElementById('disconnectChatBtn');
        const nextBtn = document.getElementById('nextBtn');
        const connectingScreen = document.getElementById('connectingScreen');
        const chatScreen = document.getElementById('chatScreen');
        const messagesContainer = document.getElementById('messagesContainer');
        const messageInput = document.getElementById('messageInput');
        const sendBtn = document.getElementById('sendBtn');
        const partnerName = document.getElementById('partnerName');
        const partnerRegion = document.getElementById('partnerRegion');
        const currentUserRegion = document.getElementById('currentUserRegion');

        // App State
        let currentUser = {
            id: 'user_' + Math.random().toString(36).substr(2, 9),
            name: '',
            region: ''
        };
        let currentPartner = null;
        let searchListener = null;
        let messageListener = null;
        let partnerDisconnectListener = null;
        let processedMessageIds = new Set(); // Для предотвращения дублирования сообщений
        let autoScroll = true;
        let inSearch = false;

        // Show notification
        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            
            let icon = 'ℹ️';
            if (type === 'success') icon = '✅';
            if (type === 'error') icon = '❌';
            
            notification.innerHTML = `<span>${icon}</span> ${message}`;
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.style.animation = 'slideIn 0.4s ease reverse';
                setTimeout(() => {
                    if (notification.parentNode) {
                        notification.parentNode.removeChild(notification);
                    }
                }, 400);
            }, 3000);
        }

        // Save profile
        saveProfileBtn.addEventListener('click', () => {
            const name = usernameInput.value.trim();
            const region = regionSelect.value;
            
            if (!name) {
                showNotification('Пожалуйста, введите имя', 'error');
                return;
            }
            
            if (!region) {
                showNotification('Пожалуйста, выберите регион', 'error');
                return;
            }
            
            currentUser.name = name;
            currentUser.region = region;
            
            // Save to sessionStorage as fallback
            try {
                sessionStorage.setItem('chatroulette_user', JSON.stringify(currentUser));
            } catch (e) {
                console.log("sessionStorage недоступен, используем память");
            }
            currentUserRegion.textContent = region;
            
            showNotification('Профиль сохранен!', 'success');
        });

        // Load profile from sessionStorage
        function loadProfile() {
            try {
                const saved = sessionStorage.getItem('chatroulette_user');
                if (saved) {
                    currentUser = JSON.parse(saved);
                    usernameInput.value = currentUser.name;
                    regionSelect.value = currentUser.region;
                    currentUserRegion.textContent = currentUser.region;
                }
            } catch (e) {
                console.log("sessionStorage недоступен");
            }
        }

        // Connect to random user
        connectBtn.addEventListener('click', () => {
            if (!currentUser.name || !currentUser.region) {
                showNotification('Сначала заполните профиль', 'error');
                return;
            }
            
            inSearch = true;
            connectingScreen.classList.remove('hidden');
            chatScreen.classList.add('hidden');
            connectBtn.classList.add('hidden');
            disconnectBtn.classList.remove('hidden');
            
            startSearch();
        });

        // Disconnect from main screen
        disconnectBtn.addEventListener('click', () => {
            disconnectFromChat();
            inSearch = false;
            connectingScreen.classList.add('hidden');
            chatScreen.classList.add('hidden');
            connectBtn.classList.remove('hidden');
            disconnectBtn.classList.add('hidden');
            messagesContainer.innerHTML = '';
            currentPartner = null;
            showNotification('Вы отключились от чата', 'info');
        });

        // Disconnect from chat screen
        disconnectChatBtn.addEventListener('click', () => {
            disconnectFromChat();
            inSearch = false;
            connectingScreen.classList.add('hidden');
            chatScreen.classList.add('hidden');
            connectBtn.classList.remove('hidden');
            disconnectBtn.classList.add('hidden');
            messagesContainer.innerHTML = '';
            currentPartner = null;
            showNotification('Вы отключились от чата', 'info');
        });

        // Next partner
        nextBtn.addEventListener('click', () => {
            if (!currentPartner) return;
            
            // Уведомляем партнера об отключении
            if (currentPartner) {
                const disconnectRef = ref(database, `disconnects/${getChatId()}/${currentUser.id}`);
                set(disconnectRef, {
                    timestamp: Date.now()
                }).catch(console.error);
            }
            
            // Очищаем текущий чат
            messagesContainer.innerHTML = '';
            processedMessageIds.clear();
            stopMessageListener();
            stopPartnerDisconnectListener();
            
            // Ищем нового партнера
            inSearch = true;
            connectingScreen.classList.remove('hidden');
            chatScreen.classList.add('hidden');
            startSearch();
        });

        // Start searching for partner
        function startSearch() {
            // Clear previous search
            stopSearch();
            
            showNotification('Поиск собеседника в регионе: ' + currentUser.region, 'info');
            
            // Add current user to search queue
            const searchRef = ref(database, `search_queue/${currentUser.region}/${currentUser.id}`);
            set(searchRef, {
                userId: currentUser.id,
                name: currentUser.name,
                timestamp: Date.now()
            }).catch(error => {
                console.error("Error adding to search queue:", error);
                showNotification('Ошибка при поиске собеседника', 'error');
            });
            
            // Listen for matches
            const queueRef = ref(database, `search_queue/${currentUser.region}`);
            searchListener = onValue(queueRef, (snapshot) => {
                const users = snapshot.val();
                if (!users) return;
                
                // Find potential partners (not ourselves)
                const potentialPartners = Object.keys(users).filter(id => id !== currentUser.id);
                
                if (potentialPartners.length > 0) {
                    const partnerId = potentialPartners[0];
                    const partner = users[partnerId];
                    
                    // Remove both users from queue
                    remove(ref(database, `search_queue/${currentUser.region}/${currentUser.id}`)).catch(console.error);
                    remove(ref(database, `search_queue/${currentUser.region}/${partnerId}`)).catch(console.error);
                    
                    // Establish connection
                    establishConnection(partnerId, partner);
                }
            }, (error) => {
                console.error("Error in search listener:", error);
                showNotification('Ошибка при поиске собеседника', 'error');
            });
        }

        // Stop searching
        function stopSearch() {
            if (searchListener) {
                off(searchListener);
                searchListener = null;
            }
            
            // Remove from queue
            if (currentUser.region) {
                remove(ref(database, `search_queue/${currentUser.region}/${currentUser.id}`)).catch(console.error);
            }
        }

        // Establish connection with partner
        function establishConnection(partnerId, partner) {
            inSearch = false;
            currentPartner = {
                id: partnerId,
                name: partner.name
            };
            
            partnerName.textContent = partner.name;
            partnerRegion.textContent = currentUser.region;
            
            connectingScreen.classList.add('hidden');
            chatScreen.classList.remove('hidden');
            
            // Очищаем обработанные сообщения
            processedMessageIds.clear();
            
            // Setup message listeners
            setupMessageListeners();
            
            // Setup partner disconnect listener
            setupPartnerDisconnectListener();
            
            // Send welcome message
            addMessage(`Собеседник ${partner.name} найден! Начните общение.`, 'system-message');
            showNotification(`Собеседник ${partner.name} найден!`, 'success');
            
            // Прокручиваем вниз
            scrollToBottom();
        }

        // Setup message listeners
        function setupMessageListeners() {
            stopMessageListener();
            
            // Listen for incoming messages
            const messagesRef = ref(database, `messages/${getChatId()}`);
            messageListener = onValue(messagesRef, (snapshot) => {
                const messages = snapshot.val();
                if (messages) {
                    Object.entries(messages).forEach(([messageId, msg]) => {
                        // Проверяем, не обрабатывали ли мы это сообщение
                        if (!processedMessageIds.has(messageId) && msg.senderId !== currentUser.id) {
                            processedMessageIds.add(messageId);
                            displayMessage(msg.text, 'received');
                        }
                    });
                }
            });
        }

        // Stop message listener
        function stopMessageListener() {
            if (messageListener) {
                off(messageListener);
                messageListener = null;
            }
        }

        // Setup partner disconnect listener
        function setupPartnerDisconnectListener() {
            stopPartnerDisconnectListener();
            
            const disconnectRef = ref(database, `disconnects/${getChatId()}`);
            partnerDisconnectListener = onValue(disconnectRef, (snapshot) => {
                const data = snapshot.val();
                if (data && Object.keys(data).some(id => id !== currentUser.id)) {
                    addMessage('Собеседник отключился от чата', 'system-message');
                    showNotification('Собеседник отключился от чата', 'info');
                    
                    // Очищаем данные отключения
                    remove(disconnectRef).catch(console.error);
                }
            });
        }

        // Stop partner disconnect listener
        function stopPartnerDisconnectListener() {
            if (partnerDisconnectListener) {
                off(partnerDisconnectListener);
                partnerDisconnectListener = null;
            }
        }

        // Disconnect from chat
        function disconnectFromChat() {
            stopSearch();
            stopMessageListener();
            stopPartnerDisconnectListener();
            
            // Уведомляем партнера об отключении
            if (currentPartner) {
                const disconnectRef = ref(database, `disconnects/${getChatId()}/${currentUser.id}`);
                set(disconnectRef, {
                    timestamp: Date.now()
                }).catch(console.error);
            }
            
            // Удаляем историю сообщений из базы данных
            if (currentPartner) {
                const messagesRef = ref(database, `messages/${getChatId()}`);
                remove(messagesRef).catch(console.error);
            }
            
            // Удаляем пользователя из очереди поиска
            if (currentUser.region) {
                remove(ref(database, `search_queue/${currentUser.region}/${currentUser.id}`)).catch(console.error);
            }
        }

        // Get chat ID (sorted user IDs)
        function getChatId() {
            const ids = [currentUser.id, currentPartner.id].sort();
            return `${ids[0]}_${ids[1]}`;
        }

        // Send message
        function sendMessage() {
            const text = messageInput.value.trim();
            if (!text || !currentPartner) return;
            
            const message = {
                senderId: currentUser.id,
                text: text,
                timestamp: Date.now()
            };
            
            // Save to database
            const messagesRef = ref(database, `messages/${getChatId()}`);
            const newMessageRef = push(messagesRef);
            set(newMessageRef, message).catch(error => {
                console.error("Error sending message:", error);
                showNotification('Ошибка при отправке сообщения', 'error');
            });
            
            // Display in UI
            displayMessage(text, 'sent');
            messageInput.value = '';
        }

        // Display message in UI
        function displayMessage(text, type) {
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${type}`;
            messageDiv.textContent = text;
            messagesContainer.appendChild(messageDiv);
            
            // Прокручиваем вниз только если пользователь не прокручивал вверх
            if (autoScroll) {
                scrollToBottom();
            }
        }

        // Add system message
        function addMessage(text, className = 'system-message') {
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${className}`;
            messageDiv.innerHTML = `<i class="fas fa-info-circle"></i> ${text}`;
            messagesContainer.appendChild(messageDiv);
            
            // Прокручиваем вниз только если пользователь не прокручивал вверх
            if (autoScroll) {
                scrollToBottom();
            }
        }

        // Прокрутка вниз
        function scrollToBottom() {
            setTimeout(() => {
                messagesContainer.scrollTop = messagesContainer.scrollHeight;
            }, 100);
        }

        // Проверка, находится ли пользователь внизу чата
        function isScrolledToBottom() {
            return messagesContainer.scrollHeight - messagesContainer.clientHeight <= messagesContainer.scrollTop + 1;
        }

        // Event listeners
        sendBtn.addEventListener('click', sendMessage);
        messageInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                sendMessage();
            }
        });

        // Отслеживаем прокрутку чата
        messagesContainer.addEventListener('scroll', () => {
            // Если пользователь прокрутил вниз, включаем автопрокрутку
            autoScroll = isScrolledToBottom();
        });

        // Initialize
        loadProfile();
        
        // Обработка закрытия вкладки
        window.addEventListener('beforeunload', () => {
            disconnectFromChat();
        });
    </script>
</body>
            </html>
